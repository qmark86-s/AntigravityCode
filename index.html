<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <title>Weapon Master v2.2</title>
    <style>
        body {
            background: #0a0a0a;
            color: #fff;
            font-family: 'Segoe UI', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0;
            padding: 20px;
            user-select: none;
        }

        #game-container {
            width: 800px;
            height: 500px;
            perspective: 600px;
            border: 4px solid #444;
            position: relative;
            overflow: hidden;
            background: #111;
            box-shadow: 0 0 30px #000;
            border-radius: 8px;
        }

        #start-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 20px;
        }

        .big-btn {
            padding: 15px 40px;
            font-size: 24px;
            background: #e74c3c;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 10px;
            font-weight: bold;
            transition: 0.2s;
        }

        .big-btn:hover {
            transform: scale(1.05);
            background: #c0392b;
        }

        .tunnel-container {
            position: absolute;
            width: 100%;
            height: 100%;
            transform-style: preserve-3d;
            perspective: 500px;
        }

        .face {
            position: absolute;
            background-size: 128px 128px;
            image-rendering: auto;
            transition: background-image 0.5s;
        }

        .wall-left {
            width: 2000px;
            height: 100%;
            left: 0;
            top: 0;
            transform-origin: left;
            transform: rotateY(90deg) translateX(-500px);
            background-color: #2a2a2a;
        }

        .wall-right {
            width: 2000px;
            height: 100%;
            right: 0;
            top: 0;
            transform-origin: right;
            transform: rotateY(-90deg) translateX(500px);
            background-color: #2a2a2a;
        }

        .floor {
            width: 100%;
            height: 2000px;
            bottom: 0;
            left: 0;
            transform-origin: bottom;
            transform: rotateX(90deg) translateY(300px);
            background-color: #1a1a1a;
        }

        .ceiling {
            width: 100%;
            height: 2000px;
            top: 0;
            left: 0;
            transform-origin: top;
            transform: rotateX(-90deg) translateY(-500px);
            background-color: #050505;
        }

        /* ë²½ë©´: ì¢Œìš° ìŠ¤í¬ë¡¤ (ì•ìœ¼ë¡œ ì§„í–‰ ëŠë‚Œ) */
        .moving .wall-left {
            animation: scrollWallLeft 0.5s linear infinite;
        }

        .moving .wall-right {
            animation: scrollWallRight 0.5s linear infinite;
        }

        /* ë°”ë‹¥/ì²œì¥: ì•ì—ì„œ ë’¤ë¡œ ìŠ¤í¬ë¡¤ */
        .moving .floor,
        .moving .ceiling {
            animation: scrollFloor 0.5s linear infinite;
        }

        @keyframes scrollWallLeft {
            from {
                background-position: 0 0;
            }

            to {
                background-position: -128px 0;
            }
        }

        @keyframes scrollWallRight {
            from {
                background-position: 0 0;
            }

            to {
                background-position: 128px 0;
            }
        }

        @keyframes scrollFloor {
            from {
                background-position: 0 0;
            }

            to {
                background-position: 0 128px;
            }
        }

        /* ëª¬ìŠ¤í„° ì»¨í…Œì´ë„ˆ - ì†Œì‹¤ì (í„°ë„ ì•ˆìª½)ì— ë°°ì¹˜ */
        #enemy-container {
            position: absolute;
            top: 15%;
            left: 50%;
            transform: translate(-50%, 0);
            text-align: center;
            display: none;
            z-index: 30;
        }

        #enemy-emoji {
            font-size: 80px;
            filter: drop-shadow(0 0 15px rgba(255, 0, 0, 0.8));
        }

        #enemy-img {
            width: 150px;
            height: 150px;
            display: none;
            object-fit: contain;
            filter: drop-shadow(0 0 15px rgba(255, 0, 0, 0.6));
            animation: enemyApproach 0.5s ease-out;
        }

        /* ëª¬ìŠ¤í„°ê°€ ì†Œì‹¤ì (ë©€ë¦¬)ì—ì„œ ë‹¤ê°€ì˜¤ëŠ” ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes enemyApproach {
            0% {
                transform: scale(0.2);
                opacity: 0.3;
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        #enemy-hud {
            background: rgba(0, 0, 0, 0.8);
            padding: 8px 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            font-weight: bold;
        }

        #hp-bar-enemy {
            width: 200px;
            height: 12px;
            background: #333;
            margin: 10px auto;
            border-radius: 6px;
            overflow: hidden;
        }

        #hp-fill-enemy {
            height: 100%;
            width: 100%;
            background: linear-gradient(90deg, #e74c3c, #c0392b);
            transition: width 0.2s;
        }

        /* 1ì¸ì¹­ ì† - í™”ë©´ ìµœì „ë°© */
        #hands {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            justify-content: center;
            gap: 30px;
            pointer-events: none;
            z-index: 100;
        }

        .hand-slot {
            font-size: 120px;
            filter: drop-shadow(5px 10px 20px rgba(0, 0, 0, 0.8));
            transition: transform 0.1s;
        }

        .hand-img {
            width: 150px;
            height: 150px;
            object-fit: contain;
            transform: scaleX(-1);
        }

        /* 1ì¸ì¹­ í€ì¹˜ - ëª¬ìŠ¤í„°(ì•/ìœ„ìª½)ë¥¼ í–¥í•´ ê³µê²© */
        #right-hand.attack-anim {
            animation: punchForward 0.15s ease-out;
        }

        @keyframes punchForward {
            0% {
                transform: translateY(0) scale(1);
            }

            50% {
                transform: translateY(-200px) scale(0.6);
            }

            100% {
                transform: translateY(0) scale(1);
            }
        }

        #ui-panel {
            width: 800px;
            padding: 10px 15px;
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            border: 2px solid #333;
            border-radius: 8px;
            margin-top: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-sizing: border-box;
        }

        .btn-small {
            padding: 8px 15px;
            background: #2c3e50;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 5px;
            margin: 0 3px;
            transition: 0.2s;
        }

        .btn-small:hover {
            background: #34495e;
        }

        .gold-txt {
            color: #f1c40f;
            font-weight: bold;
            font-size: 18px;
        }

        #shop-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 2000;
            display: none;
            flex-direction: column;
            align-items: center;
            padding: 40px;
            overflow-y: auto;
        }

        .shop-window {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            padding: 25px;
            border-radius: 15px;
            border: 2px solid #0f3460;
            max-height: 80vh;
            overflow-y: auto;
        }

        .shop-item {
            display: flex;
            justify-content: space-between;
            padding: 12px;
            margin: 8px 0;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 8px;
            cursor: pointer;
            transition: 0.2s;
        }

        .shop-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        #stat-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 2000;
            display: none;
            flex-direction: column;
            align-items: center;
            padding: 40px;
            overflow-y: auto;
        }

        .stat-window {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            padding: 25px;
            border-radius: 15px;
            border: 2px solid #0f3460;
            width: 400px;
            max-height: 80vh;
            overflow-y: auto;
        }

        #gacha-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 2000;
            display: none;
            flex-direction: column;
            align-items: center;
            padding: 40px;
            overflow-y: auto;
        }

        #settings-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 2000;
            display: none;
            flex-direction: column;
            align-items: center;
            padding: 40px;
            overflow-y: auto;
        }


        .res-row {
            display: flex;
            align-items: center;
            margin: 8px 0;
            gap: 10px;
        }

        .res-label {
            width: 80px;
        }

        .res-input {
            width: 300px;
            padding: 5px;
        }

        .res-preview {
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .res-preview img {
            max-width: 50px;
            max-height: 50px;
        }

        .btn-save {
            background: #27ae60;
            color: white;
            padding: 10px 25px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 20px 5px;
        }

        .btn-reset {
            background: #e74c3c;
            color: white;
            padding: 10px 25px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 20px 5px;
        }

        #shop-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1500;
            display: none;
            justify-content: center;
            align-items: center;
        }

        .shop-window {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            padding: 30px;
            border-radius: 15px;
            width: 350px;
        }

        .shop-item {
            display: flex;
            justify-content: space-between;
            padding: 12px;
            margin: 8px 0;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 8px;
            cursor: pointer;
            transition: 0.2s;
        }

        .shop-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        #log-box {
            position: absolute;
            left: 10px;
            bottom: 10px;
            width: 250px;
            height: 120px;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px;
            font-size: 12px;
            overflow-y: auto;
            border-radius: 5px;
            z-index: 100;
        }

        .dmg-text {
            position: absolute;
            top: 40%;
            left: 50%;
            font-size: 50px;
            font-weight: bold;
            color: #fff;
            text-shadow: 2px 2px 5px #000;
            pointer-events: none;
            animation: dmgUp 0.8s ease-out forwards;
            z-index: 200;
        }

        @keyframes dmgUp {
            0% {
                opacity: 1;
                transform: translate(-50%, 0);
            }

            100% {
                opacity: 0;
                transform: translate(-50%, -80px);
            }
        }

        @keyframes shake {

            0%,
            100% {
                transform: translateX(0);
            }

            25% {
                transform: translateX(-5px);
            }

            75% {
                transform: translateX(5px);
            }
        }

        #game-container.shake {
            animation: shake 0.3s ease-in-out;
        }

        /* ìŠ¤íƒ¯ íŒ¨ë„ */
        #stat-panel {
            width: 800px;
            margin-top: 10px;
            padding: 15px;
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            border: 2px solid #0f3460;
            border-radius: 10px;
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            box-sizing: border-box;
        }

        .stat-box {
            background: rgba(0, 0, 0, 0.4);
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #333;
        }

        .stat-box .stat-icon {
            font-size: 24px;
        }

        .stat-box .stat-name {
            font-size: 11px;
            color: #888;
            margin: 5px 0 3px 0;
        }

        .stat-box .stat-value {
            font-size: 16px;
            font-weight: bold;
            color: #fff;
        }

        .stat-atk .stat-value {
            color: #e74c3c;
        }

        .stat-hp .stat-value {
            color: #2ecc71;
        }

        .stat-aspd .stat-value {
            color: #3498db;
        }

        .stat-crit .stat-value {
            color: #f39c12;
        }

        .stat-critdmg .stat-value {
            color: #9b59b6;
        }

        /* ìŠ¤íƒ¯ ë¶„ë°° ì˜¤ë²„ë ˆì´ */
        #stat-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 1500;
            display: none;
            justify-content: center;
            align-items: center;
        }

        .stat-window {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            padding: 30px;
            border-radius: 15px;
            width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            text-align: center;
            border: 3px solid #f1c40f;
        }

        .stat-window h2 {
            color: #f1c40f;
            margin-bottom: 10px;
        }

        .stat-points-display {
            font-size: 24px;
            color: #3498db;
            margin-bottom: 20px;
        }

        .stat-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 15px;
            margin: 8px 0;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 8px;
        }

        .stat-row-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .stat-row-icon {
            font-size: 24px;
        }

        .stat-row-name {
            font-size: 14px;
            color: #aaa;
        }

        .stat-row-value {
            font-size: 18px;
            font-weight: bold;
            min-width: 80px;
        }

        .stat-row-invested {
            font-size: 12px;
            color: #888;
        }

        .stat-row-btns {
            display: flex;
            gap: 5px;
        }

        .stat-btn {
            width: 35px;
            height: 35px;
            border: none;
            border-radius: 5px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: 0.2s;
        }

        .stat-btn-add {
            background: #27ae60;
            color: white;
        }

        .stat-btn-add:hover {
            background: #2ecc71;
            transform: scale(1.1);
        }

        .stat-btn-add:disabled {
            background: #555;
            cursor: not-allowed;
        }

        .btn-reset-stats {
            margin-top: 20px;
            padding: 10px 25px;
            background: #c0392b;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .btn-close-stats {
            margin-top: 15px;
            padding: 15px 40px;
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(39, 174, 96, 0.4);
            transition: 0.2s;
        }

        .btn-close-stats:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(39, 174, 96, 0.6);
        }
    </style>
</head>

<body>
    <div id="game-container">
        <div class="tunnel-container">
            <div class="face wall-left"></div>
            <div class="face wall-right"></div>
            <div class="face floor"></div>
            <div class="face ceiling"></div>
        </div>

        <div id="start-screen">
            <h1 style="font-size:48px;text-shadow:0 0 20px #e74c3c">âš”ï¸ Weapon Master</h1>
            <p style="color:#888">v2.2 - 3D Resources</p>
            <button class="big-btn" onclick="game.start()">ğŸ® ëª¨í—˜ ì‹œì‘</button>
        </div>

        <div id="log-box"></div>

        <!-- ì»¤ìŠ¤í…€ í™•ì¸ ëª¨ë‹¬ -->
        <div id="confirm-modal"
            style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);z-index:9999;justify-content:center;align-items:center;">
            <div
                style="background:linear-gradient(180deg,#2a2a3d,#1a1a2e);padding:30px;border-radius:15px;border:2px solid #8b5cf6;max-width:400px;text-align:center;box-shadow:0 0 30px rgba(139,92,246,0.5);">
                <div id="modal-title" style="font-size:20px;font-weight:bold;color:#fff;margin-bottom:15px;"></div>
                <div id="modal-message" style="color:#ccc;margin-bottom:25px;white-space:pre-line;line-height:1.6;">
                </div>
                <div id="modal-buttons" style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap;">
                    <!-- ë²„íŠ¼ë“¤ì´ ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
                </div>
            </div>
        </div>

        <div id="settings-overlay">
            <h1>âš™ï¸ ì„¤ì •</h1>

            <!-- ìºë¦­í„° ìŠ¬ë¡¯ ì„¹ì…˜ -->
            <div style="margin:20px 0;background:rgba(0,0,0,0.5);padding:15px;border-radius:10px;">
                <h2>ğŸ’¾ ìºë¦­í„° ìŠ¬ë¡¯</h2>
                <p style="font-size:12px;color:#888;margin-bottom:10px;">ë‹¤ì´ì•„ëŠ” ëª¨ë“  ìºë¦­í„°ê°€ ê³µìœ í•©ë‹ˆë‹¤.</p>
                <div id="slot-container">
                    <!-- ìŠ¬ë¡¯ UIê°€ ì—¬ê¸°ì— ë Œë”ë§ë¨ -->
                </div>
            </div>

            <!-- ê²Œì„ ì„¤ì • ì„¹ì…˜ -->
            <div style="margin:20px 0;background:rgba(0,0,0,0.5);padding:15px;border-radius:10px;">
                <h2>ğŸ® ê²Œì„ ì„¤ì •</h2>
                <div style="display:flex;flex-direction:column;gap:10px;margin-top:10px;">
                    <label style="display:flex;align-items:center;gap:10px;cursor:pointer;">
                        <input type="checkbox" id="opt-autosave" checked
                            onchange="game.autoSave = this.checked; game.saveProgress();">
                        ğŸ’¾ ìë™ì €ì¥
                    </label>
                    <label style="display:flex;align-items:center;gap:10px;cursor:pointer;">
                        <input type="checkbox" id="opt-dmgtext" checked
                            onchange="game.showDamageText = this.checked; game.saveProgress();">
                        ğŸ’¥ ë°ë¯¸ì§€ í…ìŠ¤íŠ¸ í‘œì‹œ
                    </label>
                </div>
                <button class="btn-reset" style="margin-top:15px;width:100%;" onclick="game.resetProgress()">ğŸ—‘ï¸ ìºë¦­í„°
                    ì´ˆê¸°í™”</button>
            </div>

            <!-- ë¦¬ì†ŒìŠ¤ ì„¤ì • ì„¹ì…˜ -->
            <div style="margin:20px 0">
                <h2>ğŸ—¡ï¸ ë¬´ê¸°</h2>
                <div id="set-weapons"></div>
                <h2>ğŸ‘¾ ëª¬ìŠ¤í„°</h2>
                <div id="set-monsters"></div>
                <h2>ğŸŒ„ ë°°ê²½</h2>
                <div id="set-backgrounds"></div>
            </div>
            <button class="btn-save" onclick="settings.save()">ğŸ’¾ ë¦¬ì†ŒìŠ¤ ì €ì¥</button>
            <button class="btn-reset" onclick="settings.reset()">ğŸ”„ ë¦¬ì†ŒìŠ¤ ì´ˆê¸°í™”</button>
            <button class="btn-small" style="margin-top:20px" onclick="settings.close()">ë‹«ê¸°</button>
        </div>

        <div id="shop-overlay">
            <div class="shop-window" style="width:450px">
                <h2 style="color:#f1c40f">â›º ìƒì </h2>
                <p>ê³¨ë“œ: <span id="shop-gold">0</span> G</p>

                <!-- í˜„ì¬ ì¥ë¹„ ìƒíƒœ -->
                <div style="background:rgba(0,0,0,0.5);padding:10px;border-radius:8px;margin-bottom:15px;">
                    <div style="font-size:14px;color:#888;margin-bottom:5px;">í˜„ì¬ ì¥ë¹„</div>
                    <div style="display:flex;align-items:center;gap:10px;">
                        <span id="shop-weapon-icon" style="font-size:40px;">ğŸ‘Š</span>
                        <div>
                            <div id="shop-weapon-name" style="font-weight:bold;">ë§¨ì£¼ë¨¹</div>
                            <div id="shop-weapon-atk" style="color:#e74c3c;font-size:12px;">ê³µê²©ë ¥ +0</div>
                        </div>
                    </div>
                </div>

                <!-- íƒ­ ë²„íŠ¼ -->
                <div style="display:flex;gap:5px;margin-bottom:10px;">
                    <button class="btn-small shop-tab active" onclick="game.switchShopTab('items')">ğŸ’ª ëŠ¥ë ¥ì¹˜</button>
                    <button class="btn-small shop-tab" onclick="game.switchShopTab('weapons')">ğŸ—¡ï¸ ë¬´ê¸°</button>
                    <button class="btn-small shop-tab" onclick="game.switchShopTab('speed')">âš¡ ë°°ì†</button>
                </div>

                <!-- ëŠ¥ë ¥ì¹˜ íƒ­ -->
                <div id="shop-items-tab">
                    <div class="shop-item" onclick="game.buy('potion')"><span>ğŸ’– íšŒë³µ</span><span>50G</span></div>
                    <div class="shop-item" onclick="game.buy('upgrade')"><span>ğŸ’ª ê³µê²©ë ¥ +5</span><span>100G</span></div>
                    <div class="shop-item" onclick="game.buy('aspd')"><span>âš¡ ê³µê²©ì†ë„ +0.1</span><span>150G</span></div>
                    <div class="shop-item" onclick="game.buy('critRate')"><span>ğŸ¯ ì¹˜ëª…íƒ€í™•ë¥  +1%</span><span>200G</span>
                    </div>
                    <div class="shop-item" onclick="game.buy('critDmg')"><span>ğŸ’¥ ì¹˜ëª…íƒ€ë°°ìˆ˜ +10%</span><span>250G</span>
                    </div>
                </div>

                <!-- ë¬´ê¸° íƒ­ -->
                <div id="shop-weapons-tab" style="display:none;max-height:250px;overflow-y:auto;">
                    <!-- ë™ì  ìƒì„± -->
                </div>

                <!-- ë°°ì† íƒ­ -->
                <div id="shop-speed-tab" style="display:none;">
                    <div style="background:rgba(0,0,0,0.3);padding:10px;border-radius:8px;margin-bottom:10px;">
                        <div style="color:#00bcd4;font-weight:bold;">í˜„ì¬ ë°°ì†: <span id="shop-current-speed">1.0x</span>
                        </div>
                    </div>

                    <div style="color:#f1c40f;font-weight:bold;margin:10px 0;">ğŸ’ ë‹¤ì´ì•„ ë°°ì† (ì˜êµ¬)</div>
                    <div id="speed-diamond-2x" class="shop-item" onclick="game.buyDiamondSpeed(1)">
                        <span>ğŸš€ 2ë°°ì†</span><span>500ğŸ’</span>
                    </div>
                    <div id="speed-diamond-4x" class="shop-item" onclick="game.buyDiamondSpeed(2)">
                        <span>âš¡ 4ë°°ì†</span><span>2000ğŸ’</span>
                    </div>

                    <div style="color:#f39c12;font-weight:bold;margin:15px 0 10px;">ğŸª™ ê³¨ë“œ ë°°ì† (ëˆ„ì  +10%)</div>
                    <div id="speed-gold-upgrade" class="shop-item" onclick="game.buyGoldSpeed()">
                        <span>ğŸ”§ ë°°ì† ê°•í™” <span id="speed-gold-level">Lv.0/5</span></span>
                        <span id="speed-gold-price">1,000G</span>
                    </div>
                </div>

                <button class="btn-small" style="margin-top:10px;width:100%" onclick="game.closeShop()">ë‚˜ê°€ê¸°</button>
            </div>
        </div>

        <div id="stat-overlay">
            <div class="stat-window">
                <h2>ğŸ“Š ìŠ¤íƒ¯ ë¶„ë°°</h2>
                <div class="stat-points-display">ë³´ìœ  í¬ì¸íŠ¸: <span id="avail-points">0</span></div>
                <div class="stat-row">
                    <div class="stat-row-info"><span class="stat-row-icon">âš”ï¸</span><span
                            class="stat-row-name">ê³µê²©ë ¥</span></div>
                    <span class="stat-row-value" id="sp-atk">10</span>
                    <span class="stat-row-invested" id="sp-atk-inv">(+0)</span>
                    <div class="stat-row-btns"><button class="stat-btn stat-btn-add"
                            onclick="game.investStat('atk')">+</button></div>
                </div>
                <div class="stat-row">
                    <div class="stat-row-info"><span class="stat-row-icon">â¤ï¸</span><span
                            class="stat-row-name">ìµœëŒ€ì²´ë ¥</span></div>
                    <span class="stat-row-value" id="sp-maxHp">100</span>
                    <span class="stat-row-invested" id="sp-maxHp-inv">(+0)</span>
                    <div class="stat-row-btns"><button class="stat-btn stat-btn-add"
                            onclick="game.investStat('maxHp')">+</button></div>
                </div>
                <div class="stat-row">
                    <div class="stat-row-info"><span class="stat-row-icon">âš¡</span><span
                            class="stat-row-name">ê³µê²©ì†ë„</span></div>
                    <span class="stat-row-value" id="sp-aspd">1.00</span>
                    <span class="stat-row-invested" id="sp-aspd-inv">(+0)</span>
                    <div class="stat-row-btns"><button class="stat-btn stat-btn-add"
                            onclick="game.investStat('aspd')">+</button></div>
                </div>
                <div class="stat-row">
                    <div class="stat-row-info"><span class="stat-row-icon">ğŸ¯</span><span
                            class="stat-row-name">ì¹˜ëª…íƒ€í™•ë¥ </span></div>
                    <span class="stat-row-value" id="sp-critRate">5%</span>
                    <span class="stat-row-invested" id="sp-critRate-inv">(+0)</span>
                    <div class="stat-row-btns"><button class="stat-btn stat-btn-add"
                            onclick="game.investStat('critRate')">+</button></div>
                </div>
                <div class="stat-row">
                    <div class="stat-row-info"><span class="stat-row-icon">ğŸ’¥</span><span
                            class="stat-row-name">ì¹˜ëª…íƒ€ë°°ìˆ˜</span></div>
                    <span class="stat-row-value" id="sp-critDmg">150%</span>
                    <span class="stat-row-invested" id="sp-critDmg-inv">(+0)</span>
                    <div class="stat-row-btns"><button class="stat-btn stat-btn-add"
                            onclick="game.investStat('critDmg')">+</button></div>
                </div>
                <button class="btn-reset-stats" onclick="game.resetStats()">ğŸ”„ ìŠ¤íƒ¯ ì´ˆê¸°í™”</button>
                <br>
                <button class="btn-close-stats" onclick="game.closeStatPanel()">âœ“ ì™„ë£Œ</button>
            </div>
        </div>

        <!-- ë½‘ê¸° ì˜¤ë²„ë ˆì´ -->
        <div id="gacha-overlay">
            <div class="shop-window" style="width:400px;text-align:center">
                <h2 style="color:#d35400">ğŸ”® ë¬´ê¸° ì†Œí™˜</h2>
                <div style="margin:20px 0;font-size:14px;color:#bdc3c7">
                    <p>ì „ì„¤ ë“±ì¥ í™•ë¥ : <span style="color:#f1c40f">1%</span></p>
                    <p>ì—í”½ 50íšŒ, ì „ì„¤ 100íšŒ ì²œì¥ ì‹œìŠ¤í…œ</p>
                    <p>ë³´ìœ  ë‹¤ì´ì•„: <span id="gacha-diamond">0</span> ğŸ’</p>
                    <p style="font-size:12px;color:#888;">ì²œì¥: <span id="gacha-pity">0</span>/100</p>
                </div>
                <div id="gacha-result" style="margin:20px 0;min-height:100px;display:none">
                    <!-- ê²°ê³¼ í‘œì‹œ ì˜ì—­ -->
                </div>
                <div style="display:flex;gap:10px;justify-content:center">
                    <button class="btn-save" onclick="game.doGacha(1)" style="flex:1">1íšŒ (100ğŸ’)</button>
                    <button class="btn-save" onclick="game.doGacha(10)" style="flex:1">10íšŒ (900ğŸ’)</button>
                </div>
                <button class="btn-small" style="margin-top:20px;width:100%" onclick="game.closeGacha()">ë‹«ê¸°</button>
            </div>
        </div>

        <!-- ì¸ë²¤í† ë¦¬ ì˜¤ë²„ë ˆì´ -->
        <div id="inventory-overlay"
            style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);z-index:500;justify-content:center;align-items:center;">
            <div class="shop-window" style="width:500px;max-height:80vh;overflow:auto;">
                <h2 style="color:#8b5cf6">ğŸ’ ê°€ë°©</h2>

                <!-- í˜„ì¬ ì¥ì°© ì¥ë¹„ -->
                <div
                    style="background:rgba(139,92,246,0.2);padding:15px;border-radius:10px;margin-bottom:15px;border:2px solid #8b5cf6;">
                    <div style="font-size:14px;color:#888;margin-bottom:8px;">í˜„ì¬ ì¥ì°©</div>
                    <div id="inv-equipped" style="display:flex;align-items:center;gap:10px;min-height:50px;">
                        <!-- ì¥ì°© ë¬´ê¸° í‘œì‹œ -->
                    </div>
                </div>

                <!-- ì¸ë²¤í† ë¦¬ ëª©ë¡ -->
                <div style="margin-bottom:15px;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                        <span style="color:#888;">ë³´ìœ  ì¥ë¹„ (<span id="inv-count">0</span>/90)</span>
                        <select id="inv-sort" onchange="game.sortInventory(this.value)"
                            style="padding:5px;border-radius:5px;background:#333;color:#fff;border:none;">
                            <option value="grade">ë“±ê¸‰ìˆœ</option>
                            <option value="atk">ê³µê²©ë ¥ìˆœ</option>
                            <option value="name">ì´ë¦„ìˆœ</option>
                        </select>
                    </div>
                    <div id="inv-list"
                        style="display:grid;grid-template-columns:repeat(6,1fr);gap:6px;max-height:400px;overflow-y:auto;">
                        <!-- ì¸ë²¤í† ë¦¬ ì•„ì´í…œë“¤ -->
                    </div>
                </div>

                <button class="btn-small" style="width:100%" onclick="game.closeInventory()">ë‹«ê¸°</button>
            </div>
        </div>

        <div id="enemy-container">
            <div id="enemy-hud">STAGE <span id="hud-stage">1</span> <span id="hud-name">ì </span></div>
            <div id="enemy-content">
                <div id="enemy-emoji"></div>
                <img id="enemy-img" src="" alt="enemy">
            </div>
            <div id="hp-bar-enemy">
                <div id="hp-fill-enemy"></div>
            </div>
        </div>

        <div id="hands">
            <div id="right-hand" class="hand-slot">
                <span id="hand-emoji">ğŸ‘Š</span>
                <img id="hand-img" class="hand-img" style="display:none;">
            </div>
        </div>
    </div>

    <div id="ui-panel"
        style="display:flex;justify-content:space-between;align-items:center;gap:20px;padding:10px 15px;">
        <!-- 1. ì™¼ìª½ ê·¸ë£¹: ìºë¦­í„° ì •ë³´ (LV/HP + EXP ë°”) -->
        <div style="display:flex;flex-direction:column;gap:5px;min-width:200px;">
            <!-- ìƒë‹¨: LV / HP -->
            <div style="display:flex;align-items:center;gap:15px;">
                <span>ğŸ‘¤ Lv.<span id="ui-lv">1</span></span>
                <span style="color:#e74c3c">â¤ï¸ <span id="ui-hp">100</span>/<span id="ui-maxhp">100</span></span>
            </div>
            <!-- í•˜ë‹¨: EXP ë°” -->
            <div
                style="background:#f0f0f0;padding:6px 10px;border-radius:5px;display:flex;align-items:center;gap:10px;">
                <span style="font-size:12px;color:#333;font-weight:bold;">EXP</span>
                <div style="flex:1;height:10px;background:#ccc;border-radius:5px;overflow:hidden;min-width:100px;">
                    <div id="exp-bar-fill"
                        style="width:0%;height:100%;background:linear-gradient(90deg,#3498db,#2ecc71);transition:width 0.3s;">
                    </div>
                </div>
                <span style="font-size:11px;color:#333;"><span id="ui-exp">0</span>/<span
                        id="ui-maxexp">100</span></span>
            </div>
        </div>

        <!-- 2. ì¤‘ì•™ ê·¸ë£¹: ì¥ë¹„ ë° ì¬í™” -->
        <div style="display:flex;flex-direction:column;gap:5px;align-items:flex-start;">
            <!-- ìƒë‹¨: í˜„ì¬ ì¥ì°© ë¬´ê¸° -->
            <div style="display:flex;align-items:center;gap:8px;">
                <span id="ui-weapon-icon" style="font-size:20px;">ğŸ—¡ï¸</span>
                <span id="ui-weapon" style="font-weight:bold;">ë§¨ì£¼ë¨¹</span>
            </div>
            <!-- í•˜ë‹¨: ê³¨ë“œ/ë‹¤ì´ì•„/ë°°ì† -->
            <div style="display:flex;gap:15px;">
                <span class="gold-txt">ğŸ’° <span id="ui-gold">0</span> G</span>
                <span style="color:#00bcd4;font-weight:bold">ğŸ’ <span id="ui-diamond">0</span></span>
                <span id="ui-speed" style="color:#f39c12;font-weight:bold">âš¡ 1.0x</span>
            </div>
        </div>

        <!-- 3. ì˜¤ë¥¸ìª½ ê·¸ë£¹: ë©”ë‰´ ë²„íŠ¼ ê·¸ë¦¬ë“œ (2ì¤„) -->
        <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:5px;">
            <!-- ìœ—ì¤„: ìƒì , ë½‘ê¸° -->
            <button class="btn-small" onclick="game.openShop()">â›º ìƒì </button>
            <button class="btn-small" onclick="game.openGacha()">ğŸ° ë½‘ê¸°</button>
            <!-- ì•„ë«ì¤„: ê°€ë°©, ìŠ¤íƒ¯, ì„¤ì • -->
            <button class="btn-small" onclick="game.openInventory()">ğŸ’ ê°€ë°©</button>
            <button class="btn-small" onclick="game.openStatPanel()">ğŸ“Š ìŠ¤íƒ¯</button>
            <button class="btn-small" onclick="settings.open()" style="grid-column:span 2;">âš™ï¸ ì„¤ì •</button>
        </div>
    </div>

    <div id="stat-panel">
        <div class="stat-box stat-atk">
            <div class="stat-icon">âš”ï¸</div>
            <div class="stat-name">ê³µê²©ë ¥</div>
            <div class="stat-value" id="stat-atk">10</div>
        </div>
        <div class="stat-box stat-hp">
            <div class="stat-icon">â¤ï¸</div>
            <div class="stat-name">ìµœëŒ€ì²´ë ¥</div>
            <div class="stat-value" id="stat-maxhp">100</div>
        </div>
        <div class="stat-box stat-aspd">
            <div class="stat-icon">âš¡</div>
            <div class="stat-name">ê³µê²©ì†ë„</div>
            <div class="stat-value" id="stat-aspd">1.00</div>
        </div>
        <div class="stat-box stat-crit">
            <div class="stat-icon">ğŸ¯</div>
            <div class="stat-name">ì¹˜ëª…íƒ€í™•ë¥ </div>
            <div class="stat-value" id="stat-crit">5.0%</div>
        </div>
        <div class="stat-box stat-critdmg">
            <div class="stat-icon">ğŸ’¥</div>
            <div class="stat-name">ì¹˜ëª…íƒ€ë°°ìˆ˜</div>
            <div class="stat-value" id="stat-critdmg">150%</div>
        </div>
    </div>

    <script>
        // ìˆ«ì í¬ë§·í„°
        const NumFormat = {
            suffixes: ['', 'K', 'M', 'B', 'T', 'Qa', 'Qi', 'Sx', 'Sp', 'Oc', 'No', 'Dc'],
            format(num) {
                if (num === null || num === undefined || isNaN(num)) return '0';
                if (num < 0) return '-' + this.format(-num);
                if (num < 1000) return Math.floor(num).toString();
                const tier = Math.floor(Math.log10(Math.abs(num)) / 3);
                if (tier >= this.suffixes.length) {
                    const exp = tier * 3;
                    return (num / Math.pow(10, exp)).toFixed(2) + 'e' + exp;
                }
                const suffix = this.suffixes[tier];
                const scale = Math.pow(10, tier * 3);
                const scaled = num / scale;
                if (scaled >= 100) return Math.floor(scaled) + suffix;
                else if (scaled >= 10) return scaled.toFixed(1).replace(/\.0$/, '') + suffix;
                else return scaled.toFixed(2).replace(/\.?0+$/, '') + suffix;
            },
            percent(num, decimals = 0) {
                return num >= 1000 ? this.format(num) + '%' : num.toFixed(decimals) + '%';
            }
        };

        // ê¸°ë³¸ ì„¤ì • (JSONì—ì„œ ë¡œë“œë¨)
        let DEFAULT_CONFIG = null;
        let GAME_CONFIG = null;

        // í´ë°± ë°ì´í„° (CORS ì˜¤ë¥˜ ì‹œ ì‚¬ìš©)
        const FALLBACK_DATA = {
            weapons: [
                { id: 0, name: "ë§¨ì£¼ë¨¹", baseAtk: 0, grade: "common", price: 0, icon: "ğŸ‘Š" },
                { id: 1, name: "ëª©ê²€", baseAtk: 5, grade: "common", price: 100, icon: "assets/weapons/wooden_sword.png" },
                { id: 2, name: "ì² ê²€", baseAtk: 15, grade: "common", price: 500, icon: "assets/weapons/iron_sword.png" },
                { id: 3, name: "í™©ê¸ˆë„ë¼", baseAtk: 30, grade: "uncommon", price: 1500, icon: "assets/weapons/golden_axe.png" },
                { id: 4, name: "ì¹´íƒ€ë‚˜", baseAtk: 45, grade: "uncommon", price: 3000, icon: "assets/weapons/katana.png" },
                { id: 5, name: "ë§ˆë²• ì§€íŒ¡ì´", baseAtk: 55, grade: "rare", price: 5000, icon: "assets/weapons/magic_staff.png" },
                { id: 6, name: "ë ˆì´ì €ê²€", baseAtk: 70, grade: "rare", price: 8000, icon: "assets/weapons/laser_sword.png" },
                { id: 7, name: "ì—‘ìŠ¤ì¹¼ë¦¬ë²„", baseAtk: 100, grade: "epic", price: 15000, icon: "assets/weapons/excalibur.png" },
                { id: 8, name: "ìš©ì‚´ì", baseAtk: 150, grade: "legendary", price: 0, icon: "assets/weapons/dragon_slayer.png" }
            ],
            grades: {
                common: { name: "ì¼ë°˜", color: "#9e9e9e", multiplier: 1.0 },
                uncommon: { name: "ê³ ê¸‰", color: "#4caf50", multiplier: 1.5 },
                rare: { name: "ë ˆì–´", color: "#2196f3", multiplier: 2.0 },
                epic: { name: "ì—í”½", color: "#9c27b0", multiplier: 3.0 },
                legendary: { name: "ì „ì„¤", color: "#ff9800", multiplier: 5.0 }
            },
            gacha: {
                goldCost: 500,
                diamondCost: 100,
                tenPullCost: 900,
                rates: { common: 50, uncommon: 30, rare: 15, epic: 4, legendary: 1 },
                pity: { epic: 50, legendary: 100 }
            },
            monsters: [
                { id: 0, name: "ìŠ¬ë¼ì„", hp: 30, atk: 5, def: 0, aspd: 0.8, exp: 10, gold: 15, icon: "assets/monsters/slime.png" },
                { id: 1, name: "ê³ ë¸”ë¦°", hp: 50, atk: 8, def: 2, aspd: 1.0, exp: 20, gold: 25, icon: "assets/monsters/goblin.png" },
                { id: 2, name: "ëŠ‘ëŒ€", hp: 45, atk: 10, def: 1, aspd: 1.3, exp: 18, gold: 20, icon: "assets/monsters/wolf.png" },
                { id: 3, name: "ì˜¤í¬", hp: 80, atk: 12, def: 5, aspd: 0.7, exp: 35, gold: 40, icon: "assets/monsters/orc.png" },
                { id: 4, name: "ìŠ¤ì¼ˆë ˆí†¤", hp: 60, atk: 15, def: 3, aspd: 1.2, exp: 30, gold: 30, icon: "assets/monsters/skeleton.png" },
                { id: 5, name: "í‘ê¸°ì‚¬", hp: 120, atk: 20, def: 8, aspd: 0.8, exp: 60, gold: 70, icon: "assets/monsters/dark_knight.png" },
                { id: 6, name: "ì•…ë§ˆ", hp: 100, atk: 22, def: 6, aspd: 0.9, exp: 55, gold: 60, icon: "assets/monsters/demon.png" },
                { id: 7, name: "ë“œë˜ê³¤", hp: 200, atk: 30, def: 12, aspd: 0.6, exp: 150, gold: 150, icon: "assets/monsters/dragon.png" }
            ],
            backgrounds: [
                { id: 0, name: "ë²½", val: "assets/textures/wall.png" },
                { id: 1, name: "ë°”ë‹¥", val: "assets/textures/floor.png" },
                { id: 2, name: "ì²œì¥", val: "#050505" }
            ]
        };

        // ë°ì´í„° ë¡œë”
        const DataLoader = {
            async loadJSON(path) {
                try {
                    const response = await fetch(path);
                    if (!response.ok) throw new Error(`Failed to load ${path}`);
                    return await response.json();
                } catch (e) {
                    console.warn(`âš ï¸ Error loading ${path}, using fallback`, e.message);
                    return null;
                }
            },
            async loadAll() {
                const [monstersData, weaponsData, configData] = await Promise.all([
                    this.loadJSON('data/monsters.json'),
                    this.loadJSON('data/weapons.json'),
                    this.loadJSON('data/config.json')
                ]);

                // JSON ë¡œë“œ ì„±ê³µ ì—¬ë¶€ í™•ì¸
                const jsonLoaded = monstersData && weaponsData;

                if (jsonLoaded) {
                    // JSONì—ì„œ ë¡œë“œ
                    DEFAULT_CONFIG = {
                        weapons: weaponsData.weapons.map((w, i) => ({
                            id: i, name: w.name, val: w.atk, price: w.price || 0, icon: w.icon
                        })),
                        monsters: monstersData.monsters,
                        backgrounds: [
                            { id: 0, name: "ë²½", val: configData?.backgrounds?.wall || "assets/textures/wall.png" },
                            { id: 1, name: "ë°”ë‹¥", val: configData?.backgrounds?.floor || "assets/textures/floor.png" },
                            { id: 2, name: "ì²œì¥", val: configData?.backgrounds?.ceiling || "#050505" }
                        ]
                    };
                    GAME_CONFIG = configData;
                    console.log('ğŸ“¦ JSON Data loaded:', { monsters: DEFAULT_CONFIG.monsters.length, weapons: DEFAULT_CONFIG.weapons.length });
                } else {
                    // í´ë°± ë°ì´í„° ì‚¬ìš©
                    DEFAULT_CONFIG = JSON.parse(JSON.stringify(FALLBACK_DATA));
                    console.log('ğŸ“¦ Using FALLBACK data (CORS/file:// issue)');
                }

                return DEFAULT_CONFIG;
            }
        };

        window.settings = {
            data: null,
            async init() {
                // JSONì—ì„œ ë¡œë“œ
                await DataLoader.loadAll();
                const saved = localStorage.getItem('wm_v22');
                this.data = saved ? JSON.parse(saved) : JSON.parse(JSON.stringify(DEFAULT_CONFIG));
            },
            open() {
                document.getElementById('settings-overlay').style.display = 'flex';
                this.renderInputs();
                // ê²Œì„ ì˜µì…˜ ì²´í¬ë°•ìŠ¤ ë™ê¸°í™”
                if (game) {
                    document.getElementById('opt-autosave').checked = game.autoSave;
                    document.getElementById('opt-dmgtext').checked = game.showDamageText;
                    game.renderSlotUI(); // ìŠ¬ë¡¯ UI ë Œë”ë§
                }
            },
            close() { document.getElementById('settings-overlay').style.display = 'none'; },
            renderInputs() {
                const render = (arr, cid, key) => {
                    const c = document.getElementById(cid);
                    c.innerHTML = '';
                    arr.forEach((it, i) => {
                        const v = it[key];
                        const isUrl = v.indexOf('http') === 0 || v.indexOf('data:') === 0 || v.indexOf('assets/') === 0;
                        c.innerHTML += `<div class="res-row"><div class="res-label">${it.name}</div><input type="text" class="res-input" id="inp-${cid}-${i}" value="${v}"><div class="res-preview">${isUrl ? `<img src="${v}">` : v}</div></div>`;
                    });
                };
                render(this.data.weapons, 'set-weapons', 'icon');
                render(this.data.monsters, 'set-monsters', 'icon');
                render(this.data.backgrounds, 'set-backgrounds', 'val');
            },
            save() {
                const save = (arr, cid, key) => arr.forEach((it, i) => { it[key] = document.getElementById(`inp-${cid}-${i}`).value; });
                save(this.data.weapons, 'set-weapons', 'icon');
                save(this.data.monsters, 'set-monsters', 'icon');
                save(this.data.backgrounds, 'set-backgrounds', 'val');
                localStorage.setItem('wm_v22', JSON.stringify(this.data));
                alert('ì €ì¥ ì™„ë£Œ!');
                if (game) game.reload();
                this.close();
            },
            reset() {
                if (confirm('ì´ˆê¸°í™”?')) {
                    localStorage.removeItem('wm_v22');
                    this.data = JSON.parse(JSON.stringify(DEFAULT_CONFIG));
                    this.renderInputs();
                    if (game) game.reload();
                    alert('ì´ˆê¸°í™” ì™„ë£Œ');
                }
            }
        };

        class Game {
            constructor() {
                this.baseStats = { atk: 10, maxHp: 100, aspd: 1.0, critRate: 5, critDmg: 150 };
                this.invested = { atk: 0, maxHp: 0, aspd: 0, critRate: 0, critDmg: 0 };
                this.statPerPoint = { atk: 2, maxHp: 10, aspd: 0.02, critRate: 0.5, critDmg: 5 };
                this.p = {
                    hp: 100, maxHp: 100, atk: 10, aspd: 1.0, critRate: 5, critDmg: 150,
                    atkRaw: 10, maxHpRaw: 100, aspdRaw: 1.0, critRateRaw: 5, critDmgRaw: 150,
                    gold: 0, diamond: 1000, lv: 1, exp: 0, maxExp: 100, wIdx: 0, statPoints: 5, pityCount: 0,
                    invested: { atk: 0, maxHp: 0, aspd: 0, critRate: 0, critDmg: 0 },
                    inventory: [], // ì¸ë²¤í† ë¦¬ (ë¬´ê¸° ê°ì²´ ë°°ì—´)
                    equippedWeapon: null, // ì¥ì°©ëœ ë¬´ê¸° ê°ì²´
                    speedDiamondTier: 0, // 0=ì—†ìŒ, 1=2ë°°ì†, 2=4ë°°ì†
                    speedGoldLevel: 0    // 0~5 (ê° +10%)
                };
                this.stage = 1;
                this.state = 'IDLE';
                this.e = null;
                this.autoSave = true; // ìë™ì €ì¥ ì˜µì…˜
                this.showDamageText = true; // ë°ë¯¸ì§€ í…ìŠ¤íŠ¸ í‘œì‹œ ì˜µì…˜

                // ì›”ë“œ & ë³´ìŠ¤ ì‹œìŠ¤í…œ
                this.stagesPerWorld = 100;
                this.bossInterval = 25;
                this.worldThemes = [
                    { name: "ë˜ì „", hue: 0 },      // ê¸°ë³¸
                    { name: "ìˆ²", hue: 90 },       // ì´ˆë¡
                    { name: "ìš©ì•”ë™êµ´", hue: 20 }, // ì£¼í™©
                    { name: "ì–¼ìŒì„±", hue: 200 },  // íŒŒë‘
                    { name: "ë§ˆì™•ì„±", hue: 280 }   // ë³´ë¼
                ];

                this.reload();
                this.loadProgress(); // ì €ì¥ëœ ì§„í–‰ìƒí™© ë¶ˆëŸ¬ì˜¤ê¸°
                this.updateUI();
            }

            // í˜„ì¬ ì›”ë“œ ë²ˆí˜¸ (1ë¶€í„° ì‹œì‘)
            get currentWorld() {
                return Math.floor((this.stage - 1) / this.stagesPerWorld) + 1;
            }

            // í˜„ì¬ ì›”ë“œ ë‚´ ìŠ¤í…Œì´ì§€ (1-100)
            get stageInWorld() {
                return ((this.stage - 1) % this.stagesPerWorld) + 1;
            }

            // ë³´ìŠ¤ ìŠ¤í…Œì´ì§€ ì—¬ë¶€
            get isBossStage() {
                return this.stageInWorld % this.bossInterval === 0;
            }

            // í˜„ì¬ ì›”ë“œ í…Œë§ˆ
            get currentTheme() {
                const idx = (this.currentWorld - 1) % this.worldThemes.length;
                return this.worldThemes[idx];
            }

            // ë°°ì† ê³„ì‚°: ë‹¤ì´ì•„ ë°°ì† Ã— (1 + ê³¨ë“œ ë³´ë„ˆìŠ¤)
            getSpeedMultiplier() {
                const diamondMult = [1, 2, 4][this.p.speedDiamondTier] || 1;
                const goldBonus = this.p.speedGoldLevel * 0.1; // 0 ~ 0.5
                return diamondMult * (1 + goldBonus);
            }

            reload() {
                this.r = settings.data;
                const bg = this.r.backgrounds;
                this.applyBg('.wall-left', bg[0].val);
                this.applyBg('.wall-right', bg[0].val);
                this.applyBg('.floor', bg[1].val);
                this.applyBg('.ceiling', bg[2].val);
                this.updateHand();
            }

            applyBg(sel, v) {
                document.querySelectorAll(sel).forEach(el => {
                    const isImage = v.indexOf('http') === 0 || v.indexOf('data:') === 0 || v.indexOf('assets/') === 0;
                    if (isImage) {
                        el.style.backgroundImage = `url('${v}')`;
                        el.style.backgroundColor = '';
                    } else {
                        el.style.backgroundImage = '';
                        el.style.backgroundColor = v;
                    }
                });
            }

            start() {
                document.getElementById('start-screen').style.display = 'none';
                this.log("ëª¨í—˜ ì‹œì‘!");
                this.walk();
            }

            walk() {
                if (this.p.hp <= 0) { this.die(); return; }
                this.state = 'WALK';
                document.querySelector('.tunnel-container').classList.add('moving');
                document.getElementById('enemy-container').style.display = 'none';
                const speed = this.getSpeedMultiplier();
                setTimeout(() => { if (this.state === 'WALK') this.meet(); }, 1500 / speed);
            }

            meet() {
                this.state = 'BATTLE';
                document.querySelector('.tunnel-container').classList.remove('moving');

                // ì›”ë“œ í…Œë§ˆ ì ìš© (hue-rotate)
                const theme = this.currentTheme;
                document.querySelector('.tunnel-container').style.filter = `hue-rotate(${theme.hue}deg)`;

                // ë³´ìŠ¤ ìŠ¤í…Œì´ì§€ í™•ì¸
                const isBoss = this.isBossStage;
                const bossMult = isBoss ? 3 : 1; // ë³´ìŠ¤ëŠ” 3ë°° ê°•í•¨

                // ëª¬ìŠ¤í„° ì„ íƒ (ë³´ìŠ¤ë©´ ë§ˆì§€ë§‰ ëª¬ìŠ¤í„°, ì•„ë‹ˆë©´ ëœë¤)
                const ml = this.r.monsters;
                const b = isBoss ? ml[ml.length - 1] : ml[Math.floor(Math.random() * (ml.length - 1))];

                // ìŠ¤ì¼€ì¼ë§: ìŠ¤í…Œì´ì§€ + ì›”ë“œ ë³´ë„ˆìŠ¤
                const stageScale = 1 + this.stage * 0.1;
                const worldScale = 1 + (this.currentWorld - 1) * 0.5;
                const m = stageScale * worldScale * bossMult;

                this.e = {
                    name: isBoss ? `ğŸ‘‘ ${b.name} (ë³´ìŠ¤)` : b.name,
                    isBoss: isBoss,
                    maxHp: Math.floor(b.hp * m),
                    hp: Math.floor(b.hp * m),
                    atk: Math.floor(b.atk * m),
                    def: Math.floor((b.def || 0) * m * 0.5),
                    aspd: b.aspd || 1.0,
                    exp: Math.floor((b.exp || 10) * m * (isBoss ? 5 : 1)),
                    gold: Math.floor((b.gold || 15) * m * (isBoss ? 5 : 1)),
                    icon: b.icon
                };

                const em = document.getElementById('enemy-emoji');
                const im = document.getElementById('enemy-img');
                const isImage = this.e.icon.indexOf('http') === 0 || this.e.icon.indexOf('data:') === 0 || this.e.icon.indexOf('assets/') === 0;
                if (isImage) {
                    em.style.display = 'none'; im.style.display = 'block'; im.src = this.e.icon;
                    // ë³´ìŠ¤ë©´ í¬ê²Œ í‘œì‹œ
                    im.style.transform = isBoss ? 'scale(1.3)' : 'scale(1)';
                    im.style.filter = isBoss ? 'drop-shadow(0 0 30px gold)' : 'drop-shadow(0 0 20px rgba(255,0,0,0.5))';
                } else {
                    im.style.display = 'none'; em.style.display = 'block'; em.innerText = this.e.icon;
                }
                document.getElementById('enemy-container').style.display = 'block';
                document.getElementById('hud-name').innerText = this.e.name;
                document.getElementById('hud-stage').innerText = `W${this.currentWorld}-${this.stageInWorld}`;
                this.updateEHp();

                if (isBoss) {
                    this.log(`ğŸ”¥ ë³´ìŠ¤ ë“±ì¥! ${this.e.name}`);
                } else {
                    this.log(`â— ${this.e.name} ë“±ì¥!`);
                }

                const speed = this.getSpeedMultiplier();
                const attackDelay = 1000 / this.p.aspd / speed;
                setTimeout(() => this.round(), attackDelay);
            }

            async round() {
                if (this.state !== 'BATTLE') return;
                this.atk(true);
                const speed = this.getSpeedMultiplier();
                if (this.e.hp <= 0) { setTimeout(() => this.win(), 500 / speed); return; }
                const attackDelay = 1000 / this.p.aspd / speed;
                await this.wait(attackDelay * 0.6);
                if (this.state === 'BATTLE') {
                    this.atk(false);
                    if (this.p.hp <= 0) this.die();
                    else setTimeout(() => this.round(), attackDelay * 0.4);
                }
            }

            atk(isP) {
                const speed = this.getSpeedMultiplier();
                if (isP) {
                    const h = document.getElementById('right-hand');
                    h.classList.add('attack-anim');
                    setTimeout(() => h.classList.remove('attack-anim'), 200 / speed);
                    const w = this.r.weapons[this.p.wIdx];
                    let d = this.p.atk + this.getWeaponAtk(w);
                    d = Math.max(1, d - Math.floor(this.e.def * 0.5));
                    let isCrit = Math.random() * 100 < this.p.critRate;
                    if (isCrit) d = Math.floor(d * (this.p.critDmg / 100));
                    this.e.hp = Math.max(0, this.e.hp - d);
                    this.updateEHp();
                    this.showDmg(d, isCrit, false);
                    this.log(`âš”ï¸ ê³µê²©! ${NumFormat.format(d)} í”¼í•´${isCrit ? ' (ì¹˜ëª…íƒ€!)' : ''}`);
                } else {
                    const g = document.getElementById('game-container');
                    g.classList.add('shake');
                    setTimeout(() => g.classList.remove('shake'), 300);
                    let d = this.e.atk;
                    this.p.hp = Math.max(0, this.p.hp - d);
                    this.updateUI();
                    this.showDmg(d, false, true);
                    this.log(`ğŸ›¡ï¸ í”¼ê²©! -${NumFormat.format(d)} HP`);
                }
            }

            win() {
                // ë³´ìŠ¤ ì²˜ì¹˜ ì‹œ ë‹¤ì´ì•„ ë³´ìƒ
                if (this.e.isBoss) {
                    const diamondReward = 5 + this.currentWorld * 5; // ì›”ë“œë‹¹ +5
                    this.p.diamond += diamondReward;
                    this.log(`ğŸ† ë³´ìŠ¤ ì²˜ì¹˜! +${NumFormat.format(this.e.exp)}EXP +${NumFormat.format(this.e.gold)}G +${diamondReward}ğŸ’`);
                } else {
                    this.log(`ğŸ† ìŠ¹ë¦¬! +${NumFormat.format(this.e.exp)}EXP +${NumFormat.format(this.e.gold)}G`);
                }

                this.p.gold += this.e.gold;
                this.p.exp += this.e.exp;
                if (this.p.exp >= this.p.maxExp) {
                    this.p.lv++;
                    this.p.exp = 0;
                    this.p.maxExp = Math.floor(this.p.maxExp * 1.2);
                    this.p.statPoints += 5;
                    this.p.hp = this.p.maxHp;
                    this.log(`ğŸ‰ ë ˆë²¨ì—…! (Lv.${this.p.lv}) +5 ìŠ¤íƒ¯ í¬ì¸íŠ¸!`);
                }
                this.stage++;
                this.updateUI();
                this.saveProgress(); // ìë™ì €ì¥
                this.walk();
            }

            die() {
                this.log(`ğŸ’€ ì‚¬ë§... ë³µê·€`);
                this.stage = 1; this.p.hp = this.p.maxHp;
                document.getElementById('enemy-container').style.display = 'none';
                this.updateUI();
                this.saveProgress(); // ìë™ì €ì¥
                setTimeout(() => this.walk(), 3000);
            }

            // ëª¨ë“  ì˜¤ë²„ë ˆì´ ë‹«ê¸°
            closeAllOverlays() {
                document.getElementById('shop-overlay').style.display = 'none';
                document.getElementById('gacha-overlay').style.display = 'none';
                document.getElementById('stat-overlay').style.display = 'none';
                document.getElementById('settings-overlay').style.display = 'none';
                document.getElementById('inventory-overlay').style.display = 'none';
            }

            openShop() {
                this.closeAllOverlays();
                document.getElementById('shop-overlay').style.display = 'flex';
                document.getElementById('shop-gold').innerText = NumFormat.format(this.p.gold);

                // í˜„ì¬ ì¥ë¹„ í‘œì‹œ
                this.updateShopEquipment();

                // ë¬´ê¸° ëª©ë¡ ë Œë”ë§
                this.renderWeaponShop();

                // ê¸°ë³¸ íƒ­ìœ¼ë¡œ ë¦¬ì…‹
                this.switchShopTab('items');
            }

            closeShop() {
                document.getElementById('shop-overlay').style.display = 'none';
            }

            updateShopEquipment() {
                const w = this.r.weapons[this.p.wIdx];
                const iconEl = document.getElementById('shop-weapon-icon');
                const isImage = w.icon && (w.icon.indexOf('http') === 0 || w.icon.indexOf('data:') === 0 || w.icon.indexOf('assets/') === 0);
                if (isImage) {
                    iconEl.innerHTML = `<img src="${w.icon}" style="width:40px;height:40px;">`;
                } else {
                    iconEl.innerText = w.icon || 'ğŸ‘Š';
                }
                const gradeInfo = this.getGradeInfo(w.grade);
                const nameEl = document.getElementById('shop-weapon-name');
                nameEl.innerText = `[${gradeInfo.name}] ${w.name}`;
                nameEl.style.color = gradeInfo.color;
                document.getElementById('shop-weapon-atk').innerText = `ê³µê²©ë ¥ +${this.getWeaponAtk(w)}`;
            }

            renderWeaponShop() {
                const container = document.getElementById('shop-weapons-tab');
                container.innerHTML = '';
                this.r.weapons.forEach((w, i) => {
                    if (i === 0) return; // ë§¨ì£¼ë¨¹ ì œì™¸
                    if (w.price === 0) return; // ë½‘ê¸° ì „ìš© ì œì™¸
                    const canBuy = this.p.gold >= w.price;
                    const isImage = w.icon && (w.icon.indexOf('http') === 0 || w.icon.indexOf('data:') === 0 || w.icon.indexOf('assets/') === 0);
                    const iconHtml = isImage ? `<img src="${w.icon}" style="width:24px;height:24px;vertical-align:middle;">` : (w.icon || 'ğŸ—¡ï¸');
                    const gradeInfo = this.getGradeInfo(w.grade);
                    const weaponAtk = this.getWeaponAtk(w);
                    container.innerHTML += `
                        <div class="shop-item" style="border-left:3px solid ${gradeInfo.color};display:flex;justify-content:space-between;align-items:center;">
                            <span style="color:${gradeInfo.color}">${iconHtml} [${gradeInfo.name}] ${w.name} (+${weaponAtk})</span>
                            <button class="btn-small" style="padding:5px 10px;${canBuy ? '' : 'opacity:0.5;cursor:not-allowed;'}" onclick="game.buyWeapon(${i})">${w.price}G êµ¬ë§¤</button>
                        </div>
                    `;
                });
            }

            switchShopTab(tab) {
                document.getElementById('shop-items-tab').style.display = tab === 'items' ? 'block' : 'none';
                document.getElementById('shop-weapons-tab').style.display = tab === 'weapons' ? 'block' : 'none';
                document.getElementById('shop-speed-tab').style.display = tab === 'speed' ? 'block' : 'none';
                document.querySelectorAll('.shop-tab').forEach((btn, i) => {
                    btn.classList.toggle('active',
                        (i === 0 && tab === 'items') ||
                        (i === 1 && tab === 'weapons') ||
                        (i === 2 && tab === 'speed'));
                });
                if (tab === 'speed') this.updateSpeedShopUI();
            }

            buyWeapon(idx) {
                const w = this.r.weapons[idx];
                if (this.p.gold < w.price) {
                    this.log('ğŸ’° ê³¨ë“œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤!');
                    return;
                }
                if (this.p.inventory.length >= 90) {
                    this.log('âš ï¸ ê°€ë°©ì´ ê½‰ ì°¨ì„œ êµ¬ë§¤í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }
                this.p.gold -= w.price;
                this.addToInventory({ ...w });

                // ìë™ ì¥ì°©: í˜„ì¬ ë¬´ê¸°ë³´ë‹¤ ì¢‹ìœ¼ë©´ ìë™ ì¥ì°©
                const currentAtk = this.p.equippedWeapon ? this.getWeaponAtk(this.p.equippedWeapon) : 0;
                const newAtk = this.getWeaponAtk(w);
                const newIdx = this.p.inventory.length - 1;

                if (newAtk > currentAtk) {
                    this.equipWeapon(newIdx);
                    this.log(`âœ¨ ${w.name} êµ¬ë§¤ ë° ìë™ ì¥ì°©! (ê³µê²©ë ¥ +${newAtk})`);
                } else {
                    this.log(`ğŸ—¡ï¸ ${w.name} êµ¬ë§¤! (ê°€ë°©ì— ì¶”ê°€ë¨)`);
                }

                this.updateUI();
                this.renderWeaponShop();
                document.getElementById('shop-gold').innerText = NumFormat.format(this.p.gold);
            }

            // ë°°ì† ìƒì  UI ì—…ë°ì´íŠ¸
            updateSpeedShopUI() {
                const speed = this.getSpeedMultiplier();
                document.getElementById('shop-current-speed').innerText = speed.toFixed(1) + 'x';

                // ë‹¤ì´ì•„ ë°°ì† ìƒíƒœ ì—…ë°ì´íŠ¸
                const tier = this.p.speedDiamondTier;
                const diamond2x = document.getElementById('speed-diamond-2x');
                const diamond4x = document.getElementById('speed-diamond-4x');

                if (tier >= 1) {
                    diamond2x.innerHTML = '<span>ğŸš€ 2ë°°ì†</span><span style="color:#27ae60">âœ“ ë³´ìœ ì¤‘</span>';
                    diamond2x.style.opacity = '0.6';
                } else {
                    diamond2x.innerHTML = '<span>ğŸš€ 2ë°°ì†</span><span>500ğŸ’</span>';
                    diamond2x.style.opacity = '1';
                }

                if (tier >= 2) {
                    diamond4x.innerHTML = '<span>âš¡ 4ë°°ì†</span><span style="color:#27ae60">âœ“ ë³´ìœ ì¤‘</span>';
                    diamond4x.style.opacity = '0.6';
                } else {
                    // ì°¨ì•¡ ê³„ì‚°
                    const cost = tier === 1 ? 1500 : 2000;
                    diamond4x.innerHTML = `<span>âš¡ 4ë°°ì†</span><span>${cost}ğŸ’</span>`;
                    diamond4x.style.opacity = '1';
                }

                // ê³¨ë“œ ë°°ì† ìƒíƒœ ì—…ë°ì´íŠ¸
                const goldLevel = this.p.speedGoldLevel;
                const goldPrices = [1000, 2000, 4000, 8000, 16000];

                if (goldLevel >= 5) {
                    document.getElementById('speed-gold-level').innerText = 'MAX';
                    document.getElementById('speed-gold-price').innerText = 'ì™„ë£Œ';
                    document.getElementById('speed-gold-upgrade').style.opacity = '0.6';
                } else {
                    document.getElementById('speed-gold-level').innerText = `Lv.${goldLevel}/5`;
                    document.getElementById('speed-gold-price').innerText = NumFormat.format(goldPrices[goldLevel]) + 'G';
                    document.getElementById('speed-gold-upgrade').style.opacity = '1';
                }
            }

            // ë‹¤ì´ì•„ ë°°ì† êµ¬ë§¤
            buyDiamondSpeed(tier) {
                if (this.p.speedDiamondTier >= tier) {
                    this.log('âš¡ ì´ë¯¸ ë³´ìœ  ì¤‘ì…ë‹ˆë‹¤!');
                    return;
                }

                // ê°€ê²© ê³„ì‚° (ì°¨ì•¡ì œ)
                const prices = [0, 500, 2000];
                const currentPaid = prices[this.p.speedDiamondTier];
                const targetPrice = prices[tier];
                const cost = targetPrice - currentPaid;

                if (this.p.diamond < cost) {
                    this.log('ğŸ’ ë‹¤ì´ì•„ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤!');
                    return;
                }

                this.p.diamond -= cost;
                this.p.speedDiamondTier = tier;

                const speedNames = ['', '2ë°°ì†', '4ë°°ì†'];
                this.log(`âš¡ ${speedNames[tier]} êµ¬ë§¤ ì™„ë£Œ! í˜„ì¬ ë°°ì†: ${this.getSpeedMultiplier().toFixed(1)}x`);

                this.updateUI();
                this.updateSpeedShopUI();
                this.saveProgress();
            }

            // ê³¨ë“œ ë°°ì† êµ¬ë§¤
            buyGoldSpeed() {
                if (this.p.speedGoldLevel >= 5) {
                    this.log('âš¡ ìµœëŒ€ ë ˆë²¨ì…ë‹ˆë‹¤!');
                    return;
                }

                const goldPrices = [1000, 2000, 4000, 8000, 16000];
                const cost = goldPrices[this.p.speedGoldLevel];

                if (this.p.gold < cost) {
                    this.log('ğŸ’° ê³¨ë“œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤!');
                    return;
                }

                this.p.gold -= cost;
                this.p.speedGoldLevel++;

                const bonus = this.p.speedGoldLevel * 10;
                this.log(`ğŸ”§ ë°°ì† ê°•í™” Lv.${this.p.speedGoldLevel}! (+${bonus}%) í˜„ì¬ ë°°ì†: ${this.getSpeedMultiplier().toFixed(1)}x`);

                this.updateUI();
                this.updateSpeedShopUI();
                document.getElementById('shop-gold').innerText = NumFormat.format(this.p.gold);
                this.saveProgress();
            }

            // ë½‘ê¸° ê´€ë ¨ í•¨ìˆ˜
            openGacha() {
                this.closeAllOverlays();
                document.getElementById('gacha-overlay').style.display = 'flex';
                document.getElementById('gacha-diamond').innerText = NumFormat.format(this.p.diamond);
                document.getElementById('gacha-pity').innerText = this.p.pityCount;
                document.getElementById('gacha-result').style.display = 'none';
            }

            closeGacha() {
                document.getElementById('gacha-overlay').style.display = 'none';
            }

            doGacha(count) {
                const cost = count === 10 ? 900 : 100;
                if (this.p.diamond < cost) {
                    this.log('ğŸ’ ë‹¤ì´ì•„ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤!');
                    return;
                }

                this.p.diamond -= cost;
                const results = [];

                for (let i = 0; i < count; i++) {
                    this.p.pityCount++;
                    const grade = this.rollGrade();
                    const weaponsOfGrade = this.r.weapons.filter(w => w.grade === grade);
                    const weapon = weaponsOfGrade.length > 0
                        ? weaponsOfGrade[Math.floor(Math.random() * weaponsOfGrade.length)]
                        : this.r.weapons[1];
                    results.push({ weapon, grade });

                    // 10ì—°ì°¨ ë³´ë„ˆìŠ¤: ë ˆì–´ ì´ìƒ í™•ì •
                    if (count === 10 && i === 9 && !results.some(r => ['rare', 'epic', 'legendary'].includes(r.grade))) {
                        const rareWeapons = this.r.weapons.filter(w => ['rare', 'epic', 'legendary'].includes(w.grade));
                        if (rareWeapons.length > 0) {
                            results[9] = { weapon: rareWeapons[Math.floor(Math.random() * rareWeapons.length)], grade: 'rare' };
                        }
                    }
                }

                // ê²°ê³¼ë¥¼ ì¸ë²¤í† ë¦¬ì— ì¶”ê°€
                results.forEach(r => {
                    this.addToInventory({ ...r.weapon, grade: r.grade });
                });

                // ê°€ì¥ ì¢‹ì€ ë¬´ê¸° ìë™ ì¥ì°© (í˜„ì¬ ì¥ì°©ë³´ë‹¤ ì¢‹ìœ¼ë©´)
                const gradeOrder = { common: 0, uncommon: 1, rare: 2, epic: 3, legendary: 4 };
                const best = results.reduce((a, b) =>
                    gradeOrder[a.grade] > gradeOrder[b.grade] ? a : b
                );

                const currentAtk = this.p.equippedWeapon ? this.p.equippedWeapon.atk : 0;
                if (best.weapon.atk > currentAtk) {
                    // ì¸ë²¤í† ë¦¬ì—ì„œ ë°©ê¸ˆ ì¶”ê°€ëœ ìµœê³  ë¬´ê¸° ì°¾ì•„ì„œ ì¥ì°©
                    const bestIdx = this.p.inventory.findIndex(w => w.name === best.weapon.name && w.grade === best.grade);
                    if (bestIdx >= 0) {
                        this.equipWeapon(bestIdx);
                        this.log(`âœ¨ ${best.weapon.name} ìë™ ì¥ì°©! (ê³µê²©ë ¥ +${best.weapon.atk})`);
                    }
                }

                // ê²°ê³¼ í‘œì‹œ
                this.showGachaResult(results);
                this.updateUI();
                document.getElementById('gacha-diamond').innerText = NumFormat.format(this.p.diamond);
                document.getElementById('gacha-pity').innerText = this.p.pityCount;
            }

            rollGrade() {
                const gacha = this.r.gacha || FALLBACK_DATA.gacha;
                const pity = this.p.pityCount;

                // ì²œì¥ ì²´í¬
                if (pity >= gacha.pity.legendary) {
                    this.p.pityCount = 0;
                    return 'legendary';
                }
                if (pity >= gacha.pity.epic && pity % gacha.pity.epic === 0) {
                    return 'epic';
                }

                // í™•ë¥  ë½‘ê¸°
                const rates = gacha.rates;
                const roll = Math.random() * 100;
                let sum = 0;
                for (const [grade, rate] of Object.entries(rates)) {
                    sum += rate;
                    if (roll < sum) return grade;
                }
                return 'common';
            }
            showGachaResult(results) {
                const container = document.getElementById('gacha-result');
                container.style.display = 'flex';
                container.style.flexWrap = 'wrap';
                container.style.justifyContent = 'center';
                container.style.gap = '10px';

                // ê²°ê³¼ HTML ìƒì„±
                container.innerHTML = results.map(r => {
                    const gradeInfo = this.getGradeInfo(r.grade);
                    const isImage = r.weapon.icon.indexOf('assets/') === 0;
                    const iconHtml = isImage ? `<img src="${r.weapon.icon}" style="width:40px;height:40px;">` : `<span style="font-size:30px">${r.weapon.icon}</span>`;

                    return `<div style="width:100px; padding:10px; background:rgba(0,0,0,0.3); border-radius:10px; border:2px solid ${gradeInfo.color}; display:flex; flex-direction:column; align-items:center;">
                                ${iconHtml}
                                <span style="color:${gradeInfo.color}; font-size:11px; margin-top:5px; font-weight:bold;">${gradeInfo.name}</span>
                                <span style="font-size:12px; margin-top:2px; text-align:center; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; width:100%;">${r.weapon.name}</span>
                            </div>`;
                }).join('');

                const best = results.reduce((a, b) => {
                    const order = ['common', 'uncommon', 'rare', 'epic', 'legendary'];
                    return order.indexOf(a.grade) > order.indexOf(b.grade) ? a : b;
                });
                this.log(`ğŸ° ${results.length}íšŒ ë½‘ê¸°! ìµœê³ : [${this.getGradeInfo(best.grade).name}] ${best.weapon.name}`);
            }

            buy(t) {
                if (t === 'potion' && this.p.gold >= 50) { this.p.gold -= 50; this.p.hp = this.p.maxHp; this.log("ğŸ’– ì²´ë ¥ íšŒë³µ!"); }
                else if (t === 'upgrade' && this.p.gold >= 100) { this.p.gold -= 100; this.p.atk += 5; this.log("ğŸ’ª ê³µê²©ë ¥ +5!"); }
                else if (t === 'aspd' && this.p.gold >= 150) { this.p.gold -= 150; this.p.aspd += 0.1; this.log("âš¡ ê³µê²©ì†ë„ +0.1!"); }
                else if (t === 'critRate' && this.p.gold >= 200) { this.p.gold -= 200; this.p.critRate = Math.min(this.p.critRate + 1, 100); this.log("ğŸ¯ ì¹˜ëª…íƒ€í™•ë¥  +1%!"); }
                else if (t === 'critDmg' && this.p.gold >= 250) { this.p.gold -= 250; this.p.critDmg += 10; this.log("ğŸ’¥ ì¹˜ëª…íƒ€ë°°ìˆ˜ +10%!"); }
                else if (t === 'gacha' && this.p.gold >= 200) {
                    this.p.gold -= 200;
                    const wl = this.r.weapons;
                    const i = Math.floor(Math.random() * (wl.length - 1)) + 1;
                    this.p.wIdx = i;
                    this.log(`ğŸ² ${wl[i].name} íšë“!`);
                }
                this.updateUI();
                this.updateHand();
                document.getElementById('shop-gold').innerText = NumFormat.format(this.p.gold);
            }

            updateHand() {
                const w = this.r.weapons[this.p.wIdx];
                const em = document.getElementById('hand-emoji');
                const im = document.getElementById('hand-img');
                const isImage = w.icon.indexOf('http') === 0 || w.icon.indexOf('data:') === 0 || w.icon.indexOf('assets/') === 0;
                if (isImage) {
                    em.style.display = 'none'; im.style.display = 'block'; im.src = w.icon;
                } else {
                    im.style.display = 'none'; em.style.display = 'block'; em.innerText = w.icon;
                }
                document.getElementById('ui-weapon').innerText = w.name;
            }

            updateUI() {
                document.getElementById('ui-lv').innerText = this.p.lv;
                document.getElementById('ui-hp').innerText = NumFormat.format(this.p.hp);
                document.getElementById('ui-maxhp').innerText = NumFormat.format(this.p.maxHp);
                document.getElementById('ui-gold').innerText = NumFormat.format(this.p.gold);
                document.getElementById('ui-diamond').innerText = NumFormat.format(this.p.diamond);

                // EXP ë°” ì—…ë°ì´íŠ¸
                document.getElementById('ui-exp').innerText = this.p.exp;
                document.getElementById('ui-maxexp').innerText = this.p.maxExp;
                const expPercent = (this.p.exp / this.p.maxExp) * 100;
                document.getElementById('exp-bar-fill').style.width = Math.min(100, expPercent) + '%';

                // ì¥ì°© ë¬´ê¸° í‘œì‹œ (equippedWeapon ìš°ì„ , ì—†ìœ¼ë©´ wIdx í´ë°±)
                const w = this.p.equippedWeapon || this.r.weapons[this.p.wIdx] || this.r.weapons[0];
                const weaponAtk = this.getWeaponAtk(w);
                const totalAtk = this.p.atk + weaponAtk;
                document.getElementById('stat-atk').innerText = NumFormat.format(totalAtk);
                document.getElementById('stat-maxhp').innerText = NumFormat.format(this.p.maxHp);
                document.getElementById('stat-aspd').innerText = this.p.aspd.toFixed(2);
                document.getElementById('stat-crit').innerText = NumFormat.percent(this.p.critRate, 1);
                document.getElementById('stat-critdmg').innerText = NumFormat.percent(this.p.critDmg, 0);

                // ë¬´ê¸° ì´ë¦„ì— ë“±ê¸‰ ìƒ‰ìƒ ì ìš©
                const gradeInfo = this.getGradeInfo(w.grade);
                const weaponEl = document.getElementById('ui-weapon');
                weaponEl.innerText = w.name;
                weaponEl.style.color = gradeInfo.color;

                // ë¬´ê¸° ì•„ì´ì½˜ ì—…ë°ì´íŠ¸
                const iconEl = document.getElementById('ui-weapon-icon');
                if (iconEl) {
                    const isImage = w.icon && (w.icon.indexOf('http') === 0 || w.icon.indexOf('data:') === 0 || w.icon.indexOf('assets/') === 0);
                    if (isImage) {
                        iconEl.innerHTML = `<img src="${w.icon}" style="width:24px;height:24px;object-fit:contain;vertical-align:middle;">`;
                    } else {
                        iconEl.innerHTML = w.icon || 'ğŸ—¡ï¸';
                    }
                }

                // ë°°ì† í‘œì‹œ ì—…ë°ì´íŠ¸
                const speedEl = document.getElementById('ui-speed');
                if (speedEl) {
                    const speed = this.getSpeedMultiplier();
                    speedEl.innerText = `âš¡ ${speed.toFixed(1)}x`;
                    speedEl.style.color = speed > 1 ? '#f39c12' : '#888';
                }

                this.updateHand();
            }

            // ë¬´ê¸° ê³µê²©ë ¥ ê³„ì‚° (ê¸°ë³¸ + ë“±ê¸‰ ë°°ìˆ˜)
            getWeaponAtk(w) {
                const baseAtk = w.baseAtk || w.val || 0;
                const gradeInfo = this.getGradeInfo(w.grade);
                return Math.floor(baseAtk * gradeInfo.multiplier);
            }

            // ë“±ê¸‰ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            getGradeInfo(grade) {
                const grades = this.r.grades || FALLBACK_DATA.grades;
                return grades[grade] || grades.common;
            }

            updateEHp() {
                if (!this.e) return;
                const p = (this.e.hp / this.e.maxHp) * 100;
                document.getElementById('hp-fill-enemy').style.width = Math.max(0, p) + "%";
            }

            showDmg(v, c, isP) {
                if (!this.showDamageText) return; // ì˜µì…˜ ì²´í¬
                const w = document.getElementById('game-container');
                const el = document.createElement('div');
                el.className = 'dmg-text';
                el.innerText = NumFormat.format(v) + (c ? "!" : "");
                if (isP) { el.style.color = 'red'; el.style.top = '60%'; }
                else if (c) { el.style.color = 'orange'; el.style.fontSize = "70px"; }
                w.appendChild(el);
                setTimeout(() => el.remove(), 800);
            }

            log(m) {
                const b = document.getElementById('log-box');
                b.innerHTML += `<div>${m}</div>`;
                b.scrollTop = b.scrollHeight;
            }

            // ìŠ¤íƒ¯ íŒ¨ë„
            openStatPanel() {
                this.closeAllOverlays();
                document.getElementById('stat-overlay').style.display = 'flex';
                this.updateStatPanel();
            }

            closeStatPanel() {
                document.getElementById('stat-overlay').style.display = 'none';
            }

            updateStatPanel() {
                document.getElementById('avail-points').innerText = this.p.statPoints;
                document.getElementById('sp-atk').innerText = NumFormat.format(this.p.atk);
                document.getElementById('sp-atk-inv').innerText = `(+${this.p.invested.atk})`;
                document.getElementById('sp-maxHp').innerText = NumFormat.format(this.p.maxHp);
                document.getElementById('sp-maxHp-inv').innerText = `(+${this.p.invested.maxHp})`;
                document.getElementById('sp-aspd').innerText = this.p.aspd.toFixed(2);
                document.getElementById('sp-aspd-inv').innerText = `(+${this.p.invested.aspd})`;
                document.getElementById('sp-critRate').innerText = NumFormat.percent(this.p.critRate, 1);
                document.getElementById('sp-critRate-inv').innerText = `(+${this.p.invested.critRate})`;
                document.getElementById('sp-critDmg').innerText = NumFormat.percent(this.p.critDmg, 0);
                document.getElementById('sp-critDmg-inv').innerText = `(+${this.p.invested.critDmg})`;
                document.querySelectorAll('.stat-btn-add').forEach(btn => { btn.disabled = this.p.statPoints <= 0; });
            }

            investStat(statName) {
                if (this.p.statPoints <= 0) return;
                this.p.statPoints--;
                this.p.invested[statName]++;
                const increase = this.statPerPoint[statName];
                this.p[statName] += increase;
                if (statName === 'maxHp') this.p.hp += increase;
                if (statName === 'critRate' && this.p.critRate > 100) this.p.critRate = 100;
                this.updateStatPanel();
                this.updateUI();
            }

            async resetStats() {
                const confirmed = await this.showConfirmModal(
                    'ğŸ”„ ìŠ¤íƒ¯ ì´ˆê¸°í™”',
                    'ì •ë§ ìŠ¤íƒ¯ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\níˆ¬ìí•œ ìŠ¤íƒ¯ í¬ì¸íŠ¸ê°€ ëª¨ë‘ ë°˜í™˜ë©ë‹ˆë‹¤.',
                    [
                        { text: 'ì´ˆê¸°í™”', value: true, style: 'background:#e74c3c' },
                        { text: 'ì·¨ì†Œ', value: false, style: 'background:#666' }
                    ]
                );
                if (!confirmed) return;

                const totalInvested = Object.values(this.p.invested).reduce((a, b) => a + b, 0);
                this.p.statPoints += totalInvested;
                this.p.atk = this.baseStats.atk;
                this.p.maxHp = this.baseStats.maxHp;
                this.p.aspd = this.baseStats.aspd;
                this.p.critRate = this.baseStats.critRate;
                this.p.critDmg = this.baseStats.critDmg;
                this.p.hp = this.p.maxHp;
                this.p.invested = { atk: 0, maxHp: 0, aspd: 0, critRate: 0, critDmg: 0 };
                this.updateStatPanel();
                this.updateUI();
                this.saveProgress();
                this.log('ğŸ”„ ìŠ¤íƒ¯ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤!');
            }

            recalcStats() {
                this.p.atk = this.p.atkRaw;
                this.p.maxHp = this.p.maxHpRaw;
                this.p.aspd = this.p.aspdRaw;
                this.p.critRate = this.p.critRateRaw;
                this.p.critDmg = this.p.critDmgRaw;
            }

            // ===== ì¸ë²¤í† ë¦¬ ì‹œìŠ¤í…œ =====
            openInventory() {
                this.closeAllOverlays();
                document.getElementById('inventory-overlay').style.display = 'flex';
                this.renderInventory();
            }

            closeInventory() {
                document.getElementById('inventory-overlay').style.display = 'none';
            }

            renderInventory() {
                console.log('=== renderInventory CALLED ===');
                // í˜„ì¬ ì¥ì°© ë¬´ê¸° í‘œì‹œ (equippedWeapon ìš°ì„ , ì—†ìœ¼ë©´ wIdx í´ë°±)
                const eqDiv = document.getElementById('inv-equipped');
                console.log('eqDiv found:', !!eqDiv);
                const w = this.p.equippedWeapon || this.r.weapons[this.p.wIdx] || this.r.weapons[0];
                console.log('Weapon w:', w?.name, 'equippedWeapon:', this.p.equippedWeapon?.name, 'wIdx:', this.p.wIdx);

                if (w && w.name !== 'ë§¨ì£¼ë¨¹') {
                    const grade = this.getGradeInfo(w.grade);
                    const weaponAtk = this.getWeaponAtk(w);
                    const isImage = w.icon && (w.icon.indexOf('http') === 0 || w.icon.indexOf('data:') === 0 || w.icon.indexOf('assets/') === 0);
                    const iconHtml = isImage
                        ? `<img src="${w.icon}" style="width:40px;height:40px;object-fit:contain;">`
                        : `<span style="font-size:40px;">${w.icon || 'ğŸ—¡ï¸'}</span>`;
                    const newHtml = `
                        ${iconHtml}
                        <div>
                            <div style="font-weight:bold;color:${grade.color}">${w.name}</div>
                            <div style="color:#e74c3c;font-size:12px;">ê³µê²©ë ¥ +${weaponAtk}</div>
                            <div style="color:#888;font-size:10px;">${grade.name}</div>
                        </div>
                        <button class="btn-small" style="margin-left:auto;" onclick="game.unequipWeapon()">í•´ì œ</button>
                    `;
                    console.log('Setting eqDiv.innerHTML with weapon:', w.name);
                    eqDiv.innerHTML = newHtml;
                    console.log('eqDiv.innerHTML NOW:', eqDiv.textContent?.substring(0, 30));
                } else {
                    eqDiv.innerHTML = '<span style="color:#888;">ì¥ì°©ëœ ì¥ë¹„ ì—†ìŒ (ë§¨ì£¼ë¨¹)</span>';
                }

                // ì¸ë²¤í† ë¦¬ ëª©ë¡ í‘œì‹œ
                const listDiv = document.getElementById('inv-list');
                const inventory = this.p.inventory || [];
                document.getElementById('inv-count').textContent = inventory.length;

                if (inventory.length === 0) {
                    listDiv.innerHTML = '<div style="grid-column:span 4;text-align:center;color:#666;padding:20px;">ì¸ë²¤í† ë¦¬ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤</div>';
                    return;
                }

                listDiv.innerHTML = inventory.map((item, idx) => {
                    const grade = this.getGradeInfo(item.grade);
                    const isEquipped = this.p.equippedWeapon && this.p.equippedWeapon.id === item.id;
                    const weaponAtk = this.getWeaponAtk(item);
                    const isImage = item.icon && (item.icon.indexOf('http') === 0 || item.icon.indexOf('data:') === 0 || item.icon.indexOf('assets/') === 0);
                    const iconHtml = isImage
                        ? `<img src="${item.icon}" style="width:32px;height:32px;object-fit:contain;">`
                        : `<span style="font-size:28px;">${item.icon || 'ğŸ—¡ï¸'}</span>`;
                    return `
                        <div class="inv-item" style="background:${grade.color}22;border:2px solid ${grade.color};border-radius:8px;padding:8px;text-align:center;cursor:pointer;${isEquipped ? 'opacity:0.5;' : ''}" 
                             onclick="game.showItemActions(${idx})">
                            ${iconHtml}
                            <div style="font-size:10px;color:${grade.color};overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${item.name}</div>
                            <div style="font-size:9px;color:#e74c3c;">+${weaponAtk}</div>
                        </div>
                    `;
                }).join('');
            }

            async showItemActions(idx) {
                // ì•„ì´í…œ IDë¥¼ ì €ì¥í•´ì„œ ì¸ë±ìŠ¤ ë³€ê²½ì— ëŒ€ì‘
                const item = this.p.inventory[idx];
                if (!item) return;
                const itemId = item.id;
                const grade = this.getGradeInfo(item.grade);
                const sellPrice = Math.floor((item.price || 100) * 0.25);
                const weaponAtk = this.getWeaponAtk(item);

                const action = await this.showConfirmModal(
                    `[${grade.name}] ${item.name}`,
                    `ê³µê²©ë ¥: +${weaponAtk}\n\nì´ ì•„ì´í…œì„ ì–´ë–»ê²Œ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`,
                    [
                        { text: 'ğŸ—¡ï¸ ì¥ì°©', value: 'equip', style: 'background:#2ecc71' },
                        { text: `ğŸ’° íŒë§¤ (${sellPrice}G)`, value: 'sell', style: 'background:#f39c12' },
                        { text: 'ì·¨ì†Œ', value: 'cancel', style: 'background:#666' }
                    ]
                );

                console.log('=== showItemActions: Modal returned ===');
                console.log('action:', action);

                // ëª¨ë‹¬ ë‹«íŒ í›„ í˜„ì¬ ì¸ë±ìŠ¤ ë‹¤ì‹œ ì°¾ê¸° (ID ê¸°ì¤€)
                const currentIdx = this.p.inventory.findIndex(i => i.id === itemId);
                console.log('currentIdx:', currentIdx, 'itemId:', itemId);
                if (currentIdx === -1) {
                    console.log('Item not found, returning early');
                    return; // ì´ë¯¸ ì œê±°ëœ ì•„ì´í…œ
                }

                if (action === 'equip') {
                    console.log('=== EQUIP BRANCH ENTERED ===');
                    this.equipWeapon(currentIdx);
                    console.log('equipWeapon completed');
                } else if (action === 'sell') {
                    console.log('=== SELL BRANCH ENTERED ===');
                    this.sellItem(currentIdx);
                } else {
                    console.log('=== NO BRANCH MATCHED ===');
                    return;
                }

                // ê°•ì œ ë¦¬í”Œë¡œìš° íŠ¸ë¦¬ê±° í›„ ë Œë”ë§
                const invOverlay = document.getElementById('inventory-overlay');
                void invOverlay.offsetHeight; // ê°•ì œ ë™ê¸° ë¦¬í”Œë¡œìš°
                this.renderInventory();
            }

            equipWeapon(idx) {
                const item = this.p.inventory[idx];
                if (!item) return;

                // ê¸°ì¡´ ì¥ì°© ë¬´ê¸°ê°€ ìˆìœ¼ë©´ ì¸ë²¤í† ë¦¬ë¡œ
                if (this.p.equippedWeapon) {
                    this.p.inventory.push(this.p.equippedWeapon);
                }

                // ìƒˆ ë¬´ê¸° ì¥ì°©
                this.p.equippedWeapon = item;
                this.p.inventory.splice(idx, 1);

                // wIdx ì—…ë°ì´íŠ¸ (ê¸°ì¡´ ì‹œìŠ¤í…œ í˜¸í™˜)
                const wepIdx = this.r.weapons.findIndex(w => w.name === item.name);
                if (wepIdx >= 0) this.p.wIdx = wepIdx;

                this.updateHand();
                // Commented out: renderInventory is called by showItemActions
                // this.renderInventory();
                this.updateUI();
                this.saveProgress();
                this.log(`ğŸ—¡ï¸ ${item.name} ì¥ì°©!`);
            }

            unequipWeapon() {
                if (!this.p.equippedWeapon) return;
                this.p.inventory.push(this.p.equippedWeapon);
                this.p.equippedWeapon = null;
                this.p.wIdx = 0; // ë§¨ì£¼ë¨¹
                this.updateHand();
                this.renderInventory();
                this.updateUI();
                this.saveProgress();
                this.log('ğŸ‘Š ë¬´ê¸° í•´ì œ, ë§¨ì£¼ë¨¹ìœ¼ë¡œ ì „íˆ¬');
            }

            sellItem(idx) {
                const item = this.p.inventory[idx];
                if (!item) return;
                const sellPrice = Math.floor((item.price || 100) * 0.25);
                this.p.gold += sellPrice;
                this.p.inventory.splice(idx, 1);
                this.renderInventory();
                this.updateUI();
                this.saveProgress();
                this.log(`ğŸ’° ${item.name} íŒë§¤! +${sellPrice}G`);
            }

            sortInventory(sortType) {
                const gradeOrder = { legendary: 0, epic: 1, rare: 2, uncommon: 3, common: 4 };

                switch (sortType) {
                    case 'grade':
                        this.p.inventory.sort((a, b) => (gradeOrder[a.grade] || 5) - (gradeOrder[b.grade] || 5));
                        break;
                    case 'atk':
                        this.p.inventory.sort((a, b) => b.atk - a.atk);
                        break;
                    case 'name':
                        this.p.inventory.sort((a, b) => a.name.localeCompare(b.name));
                        break;
                }
                this.renderInventory();
            }

            // ë¬´ê¸° íšë“ ì‹œ ì¸ë²¤í† ë¦¬ì— ì¶”ê°€
            addToInventory(weapon) {
                // 90ì¹¸ ì œí•œ ì²´í¬
                const MAX_SLOTS = 90;
                if (this.p.inventory.length >= MAX_SLOTS) {
                    this.log('âš ï¸ ê°€ë°©ì´ ê½‰ ì°¨ì„œ ì „ë¦¬í’ˆì„ ìë™ìœ¼ë¡œ íšë“í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    return false;
                }
                // ê³ ìœ  ID ë¶€ì—¬
                const newWeapon = {
                    ...weapon,
                    id: Date.now() + Math.random(),
                    price: weapon.price || (weapon.atk * 10)
                };
                this.p.inventory.push(newWeapon);
                this.saveProgress();
                return true;
            }

            // ì§„í–‰ìƒí™© ì €ì¥ (ìŠ¬ë¡¯ ì‹œìŠ¤í…œ ì—°ë™)
            saveProgress() {
                if (!this.autoSave) return;

                // ê³µìœ  ë‹¤ì´ì•„ ì—…ë°ì´íŠ¸
                this.setSharedDiamond(this.p.diamond);

                const currentSlot = this.getCurrentSlot();
                const saveData = {
                    p: { ...this.p, diamond: 0 }, // ìŠ¬ë¡¯ ë°ì´í„°ì—ëŠ” ë‹¤ì´ì•„ 0 (ê³µìœ )
                    stage: this.stage,
                    autoSave: this.autoSave,
                    showDamageText: this.showDamageText,
                    savedAt: new Date().toISOString()
                };
                localStorage.setItem('wm_progress_' + currentSlot, JSON.stringify(saveData));
                localStorage.setItem('wm_progress', JSON.stringify(saveData)); // í˜¸í™˜ì„±
                console.log('ğŸ’¾ ì§„í–‰ìƒí™© ì €ì¥ë¨ (ìŠ¬ë¡¯ ' + (currentSlot + 1) + ')');
            }

            // ì§„í–‰ìƒí™© ë¶ˆëŸ¬ì˜¤ê¸° (ìŠ¬ë¡¯ ì‹œìŠ¤í…œ ì—°ë™)
            loadProgress() {
                const currentSlot = this.getCurrentSlot();

                // ìŠ¬ë¡¯ ë°ì´í„° ë˜ëŠ” ê¸°ì¡´ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
                let saved = localStorage.getItem('wm_progress_' + currentSlot);
                if (!saved) {
                    saved = localStorage.getItem('wm_progress'); // í˜¸í™˜ì„±
                }

                if (saved) {
                    try {
                        const data = JSON.parse(saved);
                        this.p = { ...this.p, ...data.p };
                        this.stage = data.stage || 1;
                        this.autoSave = data.autoSave !== undefined ? data.autoSave : true;
                        this.showDamageText = data.showDamageText !== undefined ? data.showDamageText : true;
                        console.log('ğŸ“‚ ì§„í–‰ìƒí™© ë¶ˆëŸ¬ì˜´ (ìŠ¬ë¡¯ ' + (currentSlot + 1) + ', Lv.' + this.p.lv + ', Stage ' + this.stage + ')');
                    } catch (e) {
                        console.warn('âš ï¸ ì €ì¥ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨', e);
                    }
                }

                // ê³µìœ  ë‹¤ì´ì•„ ì ìš©
                this.p.diamond = this.getSharedDiamond();

                // ì‹ ê·œ ìœ ì €ëŠ” ê¸°ë³¸ ë‹¤ì´ì•„ 1000 ì§€ê¸‰
                if (this.p.diamond === 0 && !saved) {
                    this.p.diamond = 1000;
                    this.setSharedDiamond(1000);
                }
            }

            // ì§„í–‰ìƒí™© ì´ˆê¸°í™” (ë‹¤ì´ì•„ ì œì™¸)
            async resetProgress() {
                const confirmed = await this.showConfirmModal(
                    'âš ï¸ ìºë¦­í„° ì´ˆê¸°í™”',
                    'ì •ë§ ìºë¦­í„°ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\në‹¤ì´ì•„ë¥¼ ì œì™¸í•œ ëª¨ë“  ì§„í–‰ìƒí™©ì´ ì´ˆê¸°í™”ë©ë‹ˆë‹¤.',
                    [
                        { text: 'ì´ˆê¸°í™”', value: true, style: 'background:#e74c3c' },
                        { text: 'ì·¨ì†Œ', value: false, style: 'background:#666' }
                    ]
                );
                if (!confirmed) return;

                // ì´ˆê¸° í”Œë ˆì´ì–´ ë°ì´í„°
                const defaultPlayer = {
                    hp: 100, maxHp: 100, atk: 10, aspd: 1.0, critRate: 5, critDmg: 150,
                    atkRaw: 10, maxHpRaw: 100, aspdRaw: 1.0, critRateRaw: 5, critDmgRaw: 150,
                    gold: 0, diamond: 0, lv: 1, exp: 0, maxExp: 100, wIdx: 0, statPoints: 5, pityCount: 0,
                    invested: { atk: 0, maxHp: 0, aspd: 0, critRate: 0, critDmg: 0 },
                    inventory: [],
                    equippedWeapon: null,
                    speedDiamondTier: 0,
                    speedGoldLevel: 0
                };

                // í˜„ì¬ ìŠ¬ë¡¯ì— ì´ˆê¸° ë°ì´í„° ì €ì¥
                const currentSlot = this.getCurrentSlot();
                const saveData = {
                    p: defaultPlayer,
                    stage: 1,
                    autoSave: true,
                    showDamageText: true,
                    savedAt: new Date().toISOString()
                };
                localStorage.setItem('wm_progress_' + currentSlot, JSON.stringify(saveData));
                localStorage.setItem('wm_progress', JSON.stringify(saveData)); // í˜¸í™˜ì„±

                alert('ìºë¦­í„°ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤!');
                location.reload();
            }

            // === ì €ì¥ ìŠ¬ë¡¯ ì‹œìŠ¤í…œ ===

            // ê³µìœ  ë‹¤ì´ì•„ ê°€ì ¸ì˜¤ê¸°
            getSharedDiamond() {
                return parseInt(localStorage.getItem('wm_shared_diamond') || '0');
            }

            // ê³µìœ  ë‹¤ì´ì•„ ì„¤ì •
            setSharedDiamond(amount) {
                localStorage.setItem('wm_shared_diamond', Math.max(0, amount).toString());
            }

            // í˜„ì¬ ìŠ¬ë¡¯ ë²ˆí˜¸ ê°€ì ¸ì˜¤ê¸° (0, 1, 2)
            getCurrentSlot() {
                return parseInt(localStorage.getItem('wm_current_slot') || '0');
            }

            // ìŠ¬ë¡¯ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
            getSlotData(slotIdx) {
                const saved = localStorage.getItem('wm_progress_' + slotIdx);
                if (saved) {
                    try {
                        return JSON.parse(saved);
                    } catch (e) {
                        return null;
                    }
                }
                return null;
            }

            // í˜„ì¬ ì§„í–‰ìƒí™©ì„ ìŠ¬ë¡¯ì— ì €ì¥
            saveToSlot(slotIdx) {
                // ë‹¤ì´ì•„ëŠ” ê³µìœ ì´ë¯€ë¡œ í˜„ì¬ ë‹¤ì´ì•„ë¥¼ ê³µìœ  í’€ì— ì €ì¥
                this.setSharedDiamond(this.p.diamond);

                const saveData = {
                    p: { ...this.p, diamond: 0 }, // ìŠ¬ë¡¯ ë°ì´í„°ì—ëŠ” ë‹¤ì´ì•„ 0
                    stage: this.stage,
                    autoSave: this.autoSave,
                    showDamageText: this.showDamageText,
                    savedAt: new Date().toISOString()
                };
                localStorage.setItem('wm_progress_' + slotIdx, JSON.stringify(saveData));
            }

            // ìŠ¬ë¡¯ì—ì„œ ì§„í–‰ìƒí™© ë¶ˆëŸ¬ì˜¤ê¸°
            loadFromSlot(slotIdx) {
                const data = this.getSlotData(slotIdx);
                if (data) {
                    this.p = { ...this.p, ...data.p };
                    this.stage = data.stage || 1;
                    this.autoSave = data.autoSave !== undefined ? data.autoSave : true;
                    this.showDamageText = data.showDamageText !== undefined ? data.showDamageText : true;
                }
                // ê³µìœ  ë‹¤ì´ì•„ ì ìš©
                this.p.diamond = this.getSharedDiamond();
            }

            // ìŠ¬ë¡¯ ë³€ê²½
            async switchSlot(newSlotIdx) {
                if (newSlotIdx < 0 || newSlotIdx > 2) return;

                const currentSlot = this.getCurrentSlot();
                if (currentSlot === newSlotIdx) {
                    await this.showConfirmModal('ì•Œë¦¼', 'ì´ë¯¸ í•´ë‹¹ ìŠ¬ë¡¯ì„ ì‚¬ìš© ì¤‘ì…ë‹ˆë‹¤.', [{ text: 'í™•ì¸', value: true }]);
                    return;
                }

                const confirmed = await this.showConfirmModal(
                    'ğŸ’¾ ìŠ¬ë¡¯ ë³€ê²½',
                    `ìŠ¬ë¡¯ ${newSlotIdx + 1}ë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\ní˜„ì¬ ì§„í–‰ìƒí™©ì´ ì €ì¥ë©ë‹ˆë‹¤.`,
                    [
                        { text: 'ë³€ê²½', value: true, style: 'background:#2ecc71' },
                        { text: 'ì·¨ì†Œ', value: false, style: 'background:#666' }
                    ]
                );
                if (!confirmed) return;

                // í˜„ì¬ ìŠ¬ë¡¯ì— ì €ì¥
                this.saveToSlot(currentSlot);

                // ìƒˆ ìŠ¬ë¡¯ìœ¼ë¡œ ë³€ê²½
                localStorage.setItem('wm_current_slot', newSlotIdx.toString());

                // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
                location.reload();
            }

            // ìŠ¬ë¡¯ ì‚­ì œ
            async deleteSlot(slotIdx) {
                const confirmed = await this.showConfirmModal(
                    'ğŸ—‘ï¸ ìŠ¬ë¡¯ ì‚­ì œ',
                    `ìŠ¬ë¡¯ ${slotIdx + 1}ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\ní•´ë‹¹ ìºë¦­í„°ì˜ ëª¨ë“  ë°ì´í„°ê°€ ì‚­ì œë©ë‹ˆë‹¤.`,
                    [
                        { text: 'ì‚­ì œ', value: true, style: 'background:#e74c3c' },
                        { text: 'ì·¨ì†Œ', value: false, style: 'background:#666' }
                    ]
                );
                if (!confirmed) return;

                localStorage.removeItem('wm_progress_' + slotIdx);
                this.renderSlotUI();
            }

            // ìŠ¬ë¡¯ UI ë Œë”ë§
            renderSlotUI() {
                const container = document.getElementById('slot-container');
                if (!container) return;

                const currentSlot = this.getCurrentSlot();
                const sharedDiamond = this.getSharedDiamond();

                let html = `<div style="margin-bottom:10px;color:#00bcd4;font-weight:bold;">ğŸ’ ê³µìœ  ë‹¤ì´ì•„: ${NumFormat.format(sharedDiamond)}</div>`;

                for (let i = 0; i < 3; i++) {
                    const data = this.getSlotData(i);
                    const isActive = i === currentSlot;
                    const isEmpty = !data;

                    let slotInfo = 'ë¹ˆ ìŠ¬ë¡¯';
                    if (data) {
                        const lv = data.p?.lv || 1;
                        const stage = data.stage || 1;
                        const savedAt = data.savedAt ? new Date(data.savedAt).toLocaleDateString() : '-';
                        slotInfo = `Lv.${lv} / Stage ${stage}<br><small style="color:#888;">${savedAt}</small>`;
                    }

                    html += `
                        <div style="display:flex;align-items:center;gap:10px;padding:10px;margin:5px 0;border-radius:8px;background:${isActive ? 'rgba(46,204,113,0.3)' : 'rgba(0,0,0,0.3)'};border:2px solid ${isActive ? '#2ecc71' : '#444'};">
                            <div style="flex:1;">
                                <div style="font-weight:bold;color:${isActive ? '#2ecc71' : '#fff'};">ìŠ¬ë¡¯ ${i + 1} ${isActive ? '(í˜„ì¬)' : ''}</div>
                                <div style="font-size:12px;color:#aaa;">${slotInfo}</div>
                            </div>
                            ${!isActive ? `<button class="btn-small" onclick="game.switchSlot(${i})" style="padding:5px 10px;">ì„ íƒ</button>` : ''}
                            ${!isEmpty && !isActive ? `<button class="btn-small" onclick="game.deleteSlot(${i})" style="padding:5px 10px;background:#e74c3c;">ì‚­ì œ</button>` : ''}
                        </div>
                    `;
                }

                container.innerHTML = html;
            }

            wait(ms) { return new Promise(r => setTimeout(r, ms)); }

            // ì»¤ìŠ¤í…€ í™•ì¸ ëª¨ë‹¬
            showConfirmModal(title, message, buttons = [{ text: 'í™•ì¸', value: true, style: '' }, { text: 'ì·¨ì†Œ', value: false, style: 'background:#666' }]) {
                return new Promise(resolve => {
                    const modal = document.getElementById('confirm-modal');
                    const titleEl = document.getElementById('modal-title');
                    const messageEl = document.getElementById('modal-message');
                    const buttonsEl = document.getElementById('modal-buttons');

                    titleEl.textContent = title;
                    messageEl.textContent = message;

                    // ë²„íŠ¼ ìƒì„±
                    buttonsEl.innerHTML = buttons.map((btn, i) =>
                        `<button class="btn-save" style="${btn.style || ''};padding:10px 25px;min-width:80px;" data-value="${i}">${btn.text}</button>`
                    ).join('');

                    // í´ë¦­ í•¸ë“¤ëŸ¬
                    const handleClick = (e) => {
                        const idx = e.target.dataset.value;
                        if (idx !== undefined) {
                            modal.style.display = 'none';
                            buttonsEl.removeEventListener('click', handleClick);
                            // ëª¨ë‹¬ì´ ì™„ì „íˆ ì‚¬ë¼ì§„ í›„ ë‹¤ìŒ í”„ë ˆì„ì—ì„œ resolve
                            requestAnimationFrame(() => {
                                requestAnimationFrame(() => {
                                    resolve(buttons[parseInt(idx)].value);
                                });
                            });
                        }
                    };
                    buttonsEl.addEventListener('click', handleClick);

                    modal.style.display = 'flex';
                });
            }
        }


        // ê²Œì„ ì´ˆê¸°í™” (async)
        window.game = null;
        (async () => {
            await settings.init();
            window.game = new Game();
            console.log('ğŸ® Game initialized with JSON data');
        })();
    </script>
</body>

</html>