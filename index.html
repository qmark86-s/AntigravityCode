<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <title>Weapon Master v2.2</title>
    <style>
        body {
            background: #0a0a0a;
            color: #fff;
            font-family: 'Segoe UI', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0;
            padding: 20px;
            user-select: none;
        }

        #game-container {
            width: 800px;
            height: 500px;
            perspective: 600px;
            border: 4px solid #444;
            position: relative;
            overflow: hidden;
            background: #111;
            box-shadow: 0 0 30px #000;
            border-radius: 8px;
        }

        #start-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 20px;
        }

        .big-btn {
            padding: 15px 40px;
            font-size: 24px;
            background: #e74c3c;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 10px;
            font-weight: bold;
            transition: 0.2s;
        }

        .big-btn:hover {
            transform: scale(1.05);
            background: #c0392b;
        }

        .tunnel-container {
            position: absolute;
            width: 100%;
            height: 100%;
            transform-style: preserve-3d;
            perspective: 500px;
        }

        .face {
            position: absolute;
            background-size: 128px 128px;
            image-rendering: auto;
            transition: background-image 0.5s;
        }

        .wall-left {
            width: 2000px;
            height: 100%;
            left: 0;
            top: 0;
            transform-origin: left;
            transform: rotateY(90deg) translateX(-500px);
            background-color: #2a2a2a;
        }

        .wall-right {
            width: 2000px;
            height: 100%;
            right: 0;
            top: 0;
            transform-origin: right;
            transform: rotateY(-90deg) translateX(500px);
            background-color: #2a2a2a;
        }

        .floor {
            width: 100%;
            height: 2000px;
            bottom: 0;
            left: 0;
            transform-origin: bottom;
            transform: rotateX(90deg) translateY(300px);
            background-color: #1a1a1a;
        }

        .ceiling {
            width: 100%;
            height: 2000px;
            top: 0;
            left: 0;
            transform-origin: top;
            transform: rotateX(-90deg) translateY(-500px);
            background-color: #050505;
        }

        /* ë²½ë©´: ì¢Œìš° ìŠ¤í¬ë¡¤ (ì•ìœ¼ë¡œ ì§„í–‰ ëŠë‚Œ) */
        .moving .wall-left {
            animation: scrollWallLeft 0.5s linear infinite;
        }

        .moving .wall-right {
            animation: scrollWallRight 0.5s linear infinite;
        }

        /* ë°”ë‹¥/ì²œì¥: ì•ì—ì„œ ë’¤ë¡œ ìŠ¤í¬ë¡¤ */
        .moving .floor,
        .moving .ceiling {
            animation: scrollFloor 0.5s linear infinite;
        }

        @keyframes scrollWallLeft {
            from {
                background-position: 0 0;
            }

            to {
                background-position: -128px 0;
            }
        }

        @keyframes scrollWallRight {
            from {
                background-position: 0 0;
            }

            to {
                background-position: 128px 0;
            }
        }

        @keyframes scrollFloor {
            from {
                background-position: 0 0;
            }

            to {
                background-position: 0 128px;
            }
        }

        /* ëª¬ìŠ¤í„° ì»¨í…Œì´ë„ˆ - ì†Œì‹¤ì (í„°ë„ ì•ˆìª½)ì— ë°°ì¹˜ */
        #enemy-container {
            position: absolute;
            top: 15%;
            left: 50%;
            transform: translate(-50%, 0);
            text-align: center;
            display: none;
            z-index: 30;
        }

        #enemy-emoji {
            font-size: 80px;
            filter: drop-shadow(0 0 15px rgba(255, 0, 0, 0.8));
        }

        #enemy-img {
            width: 150px;
            height: 150px;
            display: none;
            object-fit: contain;
            filter: drop-shadow(0 0 15px rgba(255, 0, 0, 0.6));
            animation: enemyApproach 0.5s ease-out;
        }

        /* ëª¬ìŠ¤í„°ê°€ ì†Œì‹¤ì (ë©€ë¦¬)ì—ì„œ ë‹¤ê°€ì˜¤ëŠ” ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes enemyApproach {
            0% {
                transform: scale(0.2);
                opacity: 0.3;
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        #enemy-hud {
            background: rgba(0, 0, 0, 0.8);
            padding: 8px 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            font-weight: bold;
        }

        #hp-bar-enemy {
            width: 200px;
            height: 12px;
            background: #333;
            margin: 10px auto;
            border-radius: 6px;
            overflow: hidden;
        }

        #hp-fill-enemy {
            height: 100%;
            width: 100%;
            background: linear-gradient(90deg, #e74c3c, #c0392b);
            transition: width 0.2s;
        }

        /* 1ì¸ì¹­ ì† - í™”ë©´ ìµœì „ë°© */
        #hands {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            justify-content: center;
            gap: 30px;
            pointer-events: none;
            z-index: 100;
        }

        .hand-slot {
            font-size: 120px;
            filter: drop-shadow(5px 10px 20px rgba(0, 0, 0, 0.8));
            transition: transform 0.1s;
        }

        .hand-img {
            width: 150px;
            height: 150px;
            object-fit: contain;
            transform: scaleX(-1);
        }

        /* 1ì¸ì¹­ í€ì¹˜ - ëª¬ìŠ¤í„°(ì•/ìœ„ìª½)ë¥¼ í–¥í•´ ê³µê²© */
        #right-hand.attack-anim {
            animation: punchForward 0.15s ease-out;
        }

        @keyframes punchForward {
            0% {
                transform: translateY(0) scale(1);
            }

            50% {
                transform: translateY(-200px) scale(0.6);
            }

            100% {
                transform: translateY(0) scale(1);
            }
        }

        #ui-panel {
            width: 800px;
            padding: 10px 15px;
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            border: 2px solid #333;
            border-radius: 8px;
            margin-top: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-sizing: border-box;
        }

        .btn-small {
            padding: 8px 15px;
            background: #2c3e50;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 5px;
            margin: 0 3px;
            transition: 0.2s;
        }

        .btn-small:hover {
            background: #34495e;
        }

        .gold-txt {
            color: #f1c40f;
            font-weight: bold;
            font-size: 18px;
        }

        #shop-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 2000;
            display: none;
            flex-direction: column;
            align-items: center;
            padding: 40px;
            overflow-y: auto;
        }

        .shop-window {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            padding: 25px;
            border-radius: 15px;
            border: 2px solid #0f3460;
            max-height: 80vh;
            overflow-y: auto;
        }

        .shop-item {
            display: flex;
            justify-content: space-between;
            padding: 12px;
            margin: 8px 0;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 8px;
            cursor: pointer;
            transition: 0.2s;
        }

        .shop-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        #stat-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 2000;
            display: none;
            flex-direction: column;
            align-items: center;
            padding: 40px;
            overflow-y: auto;
        }

        .stat-window {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            padding: 25px;
            border-radius: 15px;
            border: 2px solid #0f3460;
            width: 400px;
            max-height: 80vh;
            overflow-y: auto;
        }

        #gacha-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 2000;
            display: none;
            flex-direction: column;
            align-items: center;
            padding: 40px;
            overflow-y: auto;
        }

        #settings-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 2000;
            display: none;
            flex-direction: column;
            align-items: center;
            padding: 40px;
            overflow-y: auto;
        }


        .res-row {
            display: flex;
            align-items: center;
            margin: 8px 0;
            gap: 10px;
        }

        .res-label {
            width: 80px;
        }

        .res-input {
            width: 300px;
            padding: 5px;
        }

        .res-preview {
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .res-preview img {
            max-width: 50px;
            max-height: 50px;
        }

        .btn-save {
            background: #27ae60;
            color: white;
            padding: 10px 25px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 20px 5px;
        }

        .btn-reset {
            background: #e74c3c;
            color: white;
            padding: 10px 25px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 20px 5px;
        }

        #shop-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1500;
            display: none;
            justify-content: center;
            align-items: center;
        }

        .shop-window {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            padding: 30px;
            border-radius: 15px;
            width: 350px;
        }

        .shop-item {
            display: flex;
            justify-content: space-between;
            padding: 12px;
            margin: 8px 0;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 8px;
            cursor: pointer;
            transition: 0.2s;
        }

        .shop-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        #log-box {
            position: absolute;
            left: 10px;
            bottom: 10px;
            width: 250px;
            height: 120px;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px;
            font-size: 12px;
            overflow-y: auto;
            border-radius: 5px;
            z-index: 100;
        }

        .dmg-text {
            position: absolute;
            top: 40%;
            left: 50%;
            font-size: 50px;
            font-weight: bold;
            color: #fff;
            text-shadow: 2px 2px 5px #000;
            pointer-events: none;
            animation: dmgUp 0.8s ease-out forwards;
            z-index: 200;
        }

        @keyframes dmgUp {
            0% {
                opacity: 1;
                transform: translate(-50%, 0);
            }

            100% {
                opacity: 0;
                transform: translate(-50%, -80px);
            }
        }

        @keyframes shake {

            0%,
            100% {
                transform: translateX(0);
            }

            25% {
                transform: translateX(-5px);
            }

            75% {
                transform: translateX(5px);
            }
        }

        #game-container.shake {
            animation: shake 0.3s ease-in-out;
        }

        /* ìŠ¤íƒ¯ íŒ¨ë„ */
        #stat-panel {
            width: 800px;
            margin-top: 10px;
            padding: 15px;
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            border: 2px solid #0f3460;
            border-radius: 10px;
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            box-sizing: border-box;
        }

        .stat-box {
            background: rgba(0, 0, 0, 0.4);
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #333;
        }

        .stat-box .stat-icon {
            font-size: 24px;
        }

        .stat-box .stat-name {
            font-size: 11px;
            color: #888;
            margin: 5px 0 3px 0;
        }

        .stat-box .stat-value {
            font-size: 16px;
            font-weight: bold;
            color: #fff;
        }

        .stat-atk .stat-value {
            color: #e74c3c;
        }

        .stat-hp .stat-value {
            color: #2ecc71;
        }

        .stat-aspd .stat-value {
            color: #3498db;
        }

        .stat-crit .stat-value {
            color: #f39c12;
        }

        .stat-critdmg .stat-value {
            color: #9b59b6;
        }

        /* ìŠ¤íƒ¯ ë¶„ë°° ì˜¤ë²„ë ˆì´ */
        #stat-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 1500;
            display: none;
            justify-content: center;
            align-items: center;
        }

        .stat-window {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            padding: 30px;
            border-radius: 15px;
            width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            text-align: center;
            border: 3px solid #f1c40f;
        }

        .stat-window h2 {
            color: #f1c40f;
            margin-bottom: 10px;
        }

        .stat-points-display {
            font-size: 24px;
            color: #3498db;
            margin-bottom: 20px;
        }

        .stat-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 15px;
            margin: 8px 0;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 8px;
        }

        .stat-row-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .stat-row-icon {
            font-size: 24px;
        }

        .stat-row-name {
            font-size: 14px;
            color: #aaa;
        }

        .stat-row-value {
            font-size: 18px;
            font-weight: bold;
            min-width: 80px;
        }

        .stat-row-invested {
            font-size: 12px;
            color: #888;
        }

        .stat-row-btns {
            display: flex;
            gap: 5px;
        }

        .stat-btn {
            width: 35px;
            height: 35px;
            border: none;
            border-radius: 5px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: 0.2s;
        }

        .stat-btn-add {
            background: #27ae60;
            color: white;
        }

        .stat-btn-add:hover {
            background: #2ecc71;
            transform: scale(1.1);
        }

        .stat-btn-add:disabled {
            background: #555;
            cursor: not-allowed;
        }

        .btn-reset-stats {
            margin-top: 20px;
            padding: 10px 25px;
            background: #c0392b;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .btn-close-stats {
            margin-top: 15px;
            padding: 15px 40px;
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(39, 174, 96, 0.4);
            transition: 0.2s;
        }

        .btn-close-stats:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(39, 174, 96, 0.6);
        }
    </style>
</head>

<body>
    <div id="game-container">
        <div class="tunnel-container">
            <div class="face wall-left"></div>
            <div class="face wall-right"></div>
            <div class="face floor"></div>
            <div class="face ceiling"></div>
        </div>

        <div id="start-screen">
            <h1 style="font-size:48px;text-shadow:0 0 20px #e74c3c">âš”ï¸ Weapon Master</h1>
            <p style="color:#888">v2.2 - 3D Resources</p>
            <button class="big-btn" onclick="game.start()">ğŸ® ëª¨í—˜ ì‹œì‘</button>
        </div>

        <div id="log-box"></div>

        <div id="settings-overlay">
            <h1>âš™ï¸ ì„¤ì •</h1>
            <div style="margin:20px 0">
                <h2>ğŸ—¡ï¸ ë¬´ê¸°</h2>
                <div id="set-weapons"></div>
                <h2>ğŸ‘¾ ëª¬ìŠ¤í„°</h2>
                <div id="set-monsters"></div>
                <h2>ğŸŒ„ ë°°ê²½</h2>
                <div id="set-backgrounds"></div>
            </div>
            <button class="btn-save" onclick="settings.save()">ğŸ’¾ ì €ì¥</button>
            <button class="btn-reset" onclick="settings.reset()">ğŸ”„ ì´ˆê¸°í™”</button>
            <button class="btn-small" style="margin-top:20px" onclick="settings.close()">ë‹«ê¸°</button>
        </div>

        <div id="shop-overlay">
            <div class="shop-window" style="width:450px">
                <h2 style="color:#f1c40f">â›º ìƒì </h2>
                <p>ê³¨ë“œ: <span id="shop-gold">0</span> G</p>

                <!-- í˜„ì¬ ì¥ë¹„ ìƒíƒœ -->
                <div style="background:rgba(0,0,0,0.5);padding:10px;border-radius:8px;margin-bottom:15px;">
                    <div style="font-size:14px;color:#888;margin-bottom:5px;">í˜„ì¬ ì¥ë¹„</div>
                    <div style="display:flex;align-items:center;gap:10px;">
                        <span id="shop-weapon-icon" style="font-size:40px;">ğŸ‘Š</span>
                        <div>
                            <div id="shop-weapon-name" style="font-weight:bold;">ë§¨ì£¼ë¨¹</div>
                            <div id="shop-weapon-atk" style="color:#e74c3c;font-size:12px;">ê³µê²©ë ¥ +0</div>
                        </div>
                    </div>
                </div>

                <!-- íƒ­ ë²„íŠ¼ -->
                <div style="display:flex;gap:5px;margin-bottom:10px;">
                    <button class="btn-small shop-tab active" onclick="game.switchShopTab('items')">ğŸ§ª ì†Œëª¨í’ˆ</button>
                    <button class="btn-small shop-tab" onclick="game.switchShopTab('weapons')">ğŸ—¡ï¸ ë¬´ê¸°</button>
                </div>

                <!-- ì†Œëª¨í’ˆ íƒ­ -->
                <div id="shop-items-tab">
                    <div class="shop-item" onclick="game.buy('potion')"><span>ğŸ’– íšŒë³µ</span><span>50G</span></div>
                    <div class="shop-item" onclick="game.buy('upgrade')"><span>ğŸ’ª ê³µê²©ë ¥ +5</span><span>100G</span></div>
                    <div class="shop-item" onclick="game.buy('aspd')"><span>âš¡ ê³µê²©ì†ë„ +0.1</span><span>150G</span></div>
                    <div class="shop-item" onclick="game.buy('critRate')"><span>ğŸ¯ ì¹˜ëª…íƒ€í™•ë¥  +1%</span><span>200G</span>
                    </div>
                    <div class="shop-item" onclick="game.buy('critDmg')"><span>ğŸ’¥ ì¹˜ëª…íƒ€ë°°ìˆ˜ +10%</span><span>250G</span>
                    </div>
                </div>

                <!-- ë¬´ê¸° íƒ­ -->
                <div id="shop-weapons-tab" style="display:none;max-height:250px;overflow-y:auto;">
                    <!-- ë™ì  ìƒì„± -->
                </div>

                <button class="btn-small" style="margin-top:10px;width:100%" onclick="game.closeShop()">ë‚˜ê°€ê¸°</button>
            </div>
        </div>

        <div id="stat-overlay">
            <div class="stat-window">
                <h2>ğŸ“Š ìŠ¤íƒ¯ ë¶„ë°°</h2>
                <div class="stat-points-display">ë³´ìœ  í¬ì¸íŠ¸: <span id="avail-points">0</span></div>
                <div class="stat-row">
                    <div class="stat-row-info"><span class="stat-row-icon">âš”ï¸</span><span
                            class="stat-row-name">ê³µê²©ë ¥</span></div>
                    <span class="stat-row-value" id="sp-atk">10</span>
                    <span class="stat-row-invested" id="sp-atk-inv">(+0)</span>
                    <div class="stat-row-btns"><button class="stat-btn stat-btn-add"
                            onclick="game.investStat('atk')">+</button></div>
                </div>
                <div class="stat-row">
                    <div class="stat-row-info"><span class="stat-row-icon">â¤ï¸</span><span
                            class="stat-row-name">ìµœëŒ€ì²´ë ¥</span></div>
                    <span class="stat-row-value" id="sp-maxHp">100</span>
                    <span class="stat-row-invested" id="sp-maxHp-inv">(+0)</span>
                    <div class="stat-row-btns"><button class="stat-btn stat-btn-add"
                            onclick="game.investStat('maxHp')">+</button></div>
                </div>
                <div class="stat-row">
                    <div class="stat-row-info"><span class="stat-row-icon">âš¡</span><span
                            class="stat-row-name">ê³µê²©ì†ë„</span></div>
                    <span class="stat-row-value" id="sp-aspd">1.00</span>
                    <span class="stat-row-invested" id="sp-aspd-inv">(+0)</span>
                    <div class="stat-row-btns"><button class="stat-btn stat-btn-add"
                            onclick="game.investStat('aspd')">+</button></div>
                </div>
                <div class="stat-row">
                    <div class="stat-row-info"><span class="stat-row-icon">ğŸ¯</span><span
                            class="stat-row-name">ì¹˜ëª…íƒ€í™•ë¥ </span></div>
                    <span class="stat-row-value" id="sp-critRate">5%</span>
                    <span class="stat-row-invested" id="sp-critRate-inv">(+0)</span>
                    <div class="stat-row-btns"><button class="stat-btn stat-btn-add"
                            onclick="game.investStat('critRate')">+</button></div>
                </div>
                <div class="stat-row">
                    <div class="stat-row-info"><span class="stat-row-icon">ğŸ’¥</span><span
                            class="stat-row-name">ì¹˜ëª…íƒ€ë°°ìˆ˜</span></div>
                    <span class="stat-row-value" id="sp-critDmg">150%</span>
                    <span class="stat-row-invested" id="sp-critDmg-inv">(+0)</span>
                    <div class="stat-row-btns"><button class="stat-btn stat-btn-add"
                            onclick="game.investStat('critDmg')">+</button></div>
                </div>
                <button class="btn-reset-stats" onclick="game.resetStats()">ğŸ”„ ìŠ¤íƒ¯ ì´ˆê¸°í™”</button>
                <br>
                <button class="btn-close-stats" onclick="game.closeStatPanel()">âœ“ ì™„ë£Œ</button>
            </div>
        </div>

        <!-- ë½‘ê¸° ì˜¤ë²„ë ˆì´ -->
        <div id="gacha-overlay">
            <div class="shop-window" style="width:400px;text-align:center">
                <h2 style="color:#d35400">ğŸ”® ë¬´ê¸° ì†Œí™˜</h2>
                <div style="margin:20px 0;font-size:14px;color:#bdc3c7">
                    <p>ì „ì„¤ ë“±ì¥ í™•ë¥ : <span style="color:#f1c40f">1%</span></p>
                    <p>ì—í”½ 50íšŒ, ì „ì„¤ 100íšŒ ì²œì¥ ì‹œìŠ¤í…œ</p>
                    <p>ë³´ìœ  ë‹¤ì´ì•„: <span id="gacha-diamond">0</span> ğŸ’</p>
                    <p style="font-size:12px;color:#888;">ì²œì¥: <span id="gacha-pity">0</span>/100</p>
                </div>
                <div id="gacha-result" style="margin:20px 0;min-height:100px;display:none">
                    <!-- ê²°ê³¼ í‘œì‹œ ì˜ì—­ -->
                </div>
                <div style="display:flex;gap:10px;justify-content:center">
                    <button class="btn-save" onclick="game.doGacha(1)" style="flex:1">1íšŒ (100ğŸ’)</button>
                    <button class="btn-save" onclick="game.doGacha(10)" style="flex:1">10íšŒ (900ğŸ’)</button>
                </div>
                <button class="btn-small" style="margin-top:20px;width:100%" onclick="game.closeGacha()">ë‹«ê¸°</button>
            </div>
        </div>

        <div id="enemy-container">
            <div id="enemy-hud">STAGE <span id="hud-stage">1</span> <span id="hud-name">ì </span></div>
            <div id="enemy-content">
                <div id="enemy-emoji"></div>
                <img id="enemy-img" src="" alt="enemy">
            </div>
            <div id="hp-bar-enemy">
                <div id="hp-fill-enemy"></div>
            </div>
        </div>

        <div id="hands">
            <div id="right-hand" class="hand-slot">
                <span id="hand-emoji">ğŸ‘Š</span>
                <img id="hand-img" class="hand-img" style="display:none;">
            </div>
        </div>
    </div>

    <div id="ui-panel">
        <div>ğŸ‘¤ Lv.<span id="ui-lv">1</span> <span style="color:#e74c3c">â¤ï¸ <span id="ui-hp">100</span>/<span
                    id="ui-maxhp">100</span></span></div>
        <div style="display:flex;align-items:center;gap:8px;margin:3px 0;">
            <div style="flex:1;height:6px;background:#333;border-radius:3px;overflow:hidden;">
                <div id="exp-bar-fill"
                    style="width:0%;height:100%;background:linear-gradient(90deg,#3498db,#9b59b6);transition:width 0.3s;">
                </div>
            </div>
            <span style="font-size:10px;color:#888;">EXP <span id="ui-exp">0</span>/<span
                    id="ui-maxexp">100</span></span>
        </div>
        <div style="text-align:center">
            <div style="display:flex;justify-content:center;gap:15px;">
                <span class="gold-txt">ğŸ’° <span id="ui-gold">0</span> G</span>
                <span style="color:#00bcd4;font-weight:bold">ğŸ’ <span id="ui-diamond">0</span></span>
            </div>
            <button class="btn-small" onclick="game.openShop()">â›º ìƒì </button>
            <button class="btn-small" onclick="game.openGacha()">ğŸ° ë½‘ê¸°</button>
            <button class="btn-small" onclick="game.openStatPanel()">ğŸ“Š ìŠ¤íƒ¯</button>
            <button class="btn-small" onclick="settings.open()">âš™ï¸ ì„¤ì •</button>
        </div>
        <div style="text-align:right">ğŸ—¡ï¸ <span id="ui-weapon">ë§¨ì£¼ë¨¹</span></div>
    </div>

    <div id="stat-panel">
        <div class="stat-box stat-atk">
            <div class="stat-icon">âš”ï¸</div>
            <div class="stat-name">ê³µê²©ë ¥</div>
            <div class="stat-value" id="stat-atk">10</div>
        </div>
        <div class="stat-box stat-hp">
            <div class="stat-icon">â¤ï¸</div>
            <div class="stat-name">ìµœëŒ€ì²´ë ¥</div>
            <div class="stat-value" id="stat-maxhp">100</div>
        </div>
        <div class="stat-box stat-aspd">
            <div class="stat-icon">âš¡</div>
            <div class="stat-name">ê³µê²©ì†ë„</div>
            <div class="stat-value" id="stat-aspd">1.00</div>
        </div>
        <div class="stat-box stat-crit">
            <div class="stat-icon">ğŸ¯</div>
            <div class="stat-name">ì¹˜ëª…íƒ€í™•ë¥ </div>
            <div class="stat-value" id="stat-crit">5.0%</div>
        </div>
        <div class="stat-box stat-critdmg">
            <div class="stat-icon">ğŸ’¥</div>
            <div class="stat-name">ì¹˜ëª…íƒ€ë°°ìˆ˜</div>
            <div class="stat-value" id="stat-critdmg">150%</div>
        </div>
    </div>

    <script>
        // ìˆ«ì í¬ë§·í„°
        const NumFormat = {
            suffixes: ['', 'K', 'M', 'B', 'T', 'Qa', 'Qi', 'Sx', 'Sp', 'Oc', 'No', 'Dc'],
            format(num) {
                if (num === null || num === undefined || isNaN(num)) return '0';
                if (num < 0) return '-' + this.format(-num);
                if (num < 1000) return Math.floor(num).toString();
                const tier = Math.floor(Math.log10(Math.abs(num)) / 3);
                if (tier >= this.suffixes.length) {
                    const exp = tier * 3;
                    return (num / Math.pow(10, exp)).toFixed(2) + 'e' + exp;
                }
                const suffix = this.suffixes[tier];
                const scale = Math.pow(10, tier * 3);
                const scaled = num / scale;
                if (scaled >= 100) return Math.floor(scaled) + suffix;
                else if (scaled >= 10) return scaled.toFixed(1).replace(/\.0$/, '') + suffix;
                else return scaled.toFixed(2).replace(/\.?0+$/, '') + suffix;
            },
            percent(num, decimals = 0) {
                return num >= 1000 ? this.format(num) + '%' : num.toFixed(decimals) + '%';
            }
        };

        // ê¸°ë³¸ ì„¤ì • (JSONì—ì„œ ë¡œë“œë¨)
        let DEFAULT_CONFIG = null;
        let GAME_CONFIG = null;

        // í´ë°± ë°ì´í„° (CORS ì˜¤ë¥˜ ì‹œ ì‚¬ìš©)
        const FALLBACK_DATA = {
            weapons: [
                { id: 0, name: "ë§¨ì£¼ë¨¹", baseAtk: 0, grade: "common", price: 0, icon: "ğŸ‘Š" },
                { id: 1, name: "ëª©ê²€", baseAtk: 5, grade: "common", price: 100, icon: "assets/weapons/wooden_sword.png" },
                { id: 2, name: "ì² ê²€", baseAtk: 15, grade: "common", price: 500, icon: "assets/weapons/iron_sword.png" },
                { id: 3, name: "í™©ê¸ˆë„ë¼", baseAtk: 30, grade: "uncommon", price: 1500, icon: "assets/weapons/golden_axe.png" },
                { id: 4, name: "ì¹´íƒ€ë‚˜", baseAtk: 45, grade: "uncommon", price: 3000, icon: "assets/weapons/katana.png" },
                { id: 5, name: "ë§ˆë²• ì§€íŒ¡ì´", baseAtk: 55, grade: "rare", price: 5000, icon: "assets/weapons/magic_staff.png" },
                { id: 6, name: "ë ˆì´ì €ê²€", baseAtk: 70, grade: "rare", price: 8000, icon: "assets/weapons/laser_sword.png" },
                { id: 7, name: "ì—‘ìŠ¤ì¹¼ë¦¬ë²„", baseAtk: 100, grade: "epic", price: 15000, icon: "assets/weapons/excalibur.png" },
                { id: 8, name: "ìš©ì‚´ì", baseAtk: 150, grade: "legendary", price: 0, icon: "assets/weapons/dragon_slayer.png" }
            ],
            grades: {
                common: { name: "ì¼ë°˜", color: "#9e9e9e", multiplier: 1.0 },
                uncommon: { name: "ê³ ê¸‰", color: "#4caf50", multiplier: 1.5 },
                rare: { name: "ë ˆì–´", color: "#2196f3", multiplier: 2.0 },
                epic: { name: "ì—í”½", color: "#9c27b0", multiplier: 3.0 },
                legendary: { name: "ì „ì„¤", color: "#ff9800", multiplier: 5.0 }
            },
            gacha: {
                goldCost: 500,
                diamondCost: 100,
                tenPullCost: 900,
                rates: { common: 50, uncommon: 30, rare: 15, epic: 4, legendary: 1 },
                pity: { epic: 50, legendary: 100 }
            },
            monsters: [
                { id: 0, name: "ìŠ¬ë¼ì„", hp: 30, atk: 5, def: 0, aspd: 0.8, exp: 10, gold: 15, icon: "assets/monsters/slime.png" },
                { id: 1, name: "ê³ ë¸”ë¦°", hp: 50, atk: 8, def: 2, aspd: 1.0, exp: 20, gold: 25, icon: "assets/monsters/goblin.png" },
                { id: 2, name: "ëŠ‘ëŒ€", hp: 45, atk: 10, def: 1, aspd: 1.3, exp: 18, gold: 20, icon: "assets/monsters/wolf.png" },
                { id: 3, name: "ì˜¤í¬", hp: 80, atk: 12, def: 5, aspd: 0.7, exp: 35, gold: 40, icon: "assets/monsters/orc.png" },
                { id: 4, name: "ìŠ¤ì¼ˆë ˆí†¤", hp: 60, atk: 15, def: 3, aspd: 1.2, exp: 30, gold: 30, icon: "assets/monsters/skeleton.png" },
                { id: 5, name: "í‘ê¸°ì‚¬", hp: 120, atk: 20, def: 8, aspd: 0.8, exp: 60, gold: 70, icon: "assets/monsters/dark_knight.png" },
                { id: 6, name: "ì•…ë§ˆ", hp: 100, atk: 22, def: 6, aspd: 0.9, exp: 55, gold: 60, icon: "assets/monsters/demon.png" },
                { id: 7, name: "ë“œë˜ê³¤", hp: 200, atk: 30, def: 12, aspd: 0.6, exp: 150, gold: 150, icon: "assets/monsters/dragon.png" }
            ],
            backgrounds: [
                { id: 0, name: "ë²½", val: "assets/textures/wall.png" },
                { id: 1, name: "ë°”ë‹¥", val: "assets/textures/floor.png" },
                { id: 2, name: "ì²œì¥", val: "#050505" }
            ]
        };

        // ë°ì´í„° ë¡œë”
        const DataLoader = {
            async loadJSON(path) {
                try {
                    const response = await fetch(path);
                    if (!response.ok) throw new Error(`Failed to load ${path}`);
                    return await response.json();
                } catch (e) {
                    console.warn(`âš ï¸ Error loading ${path}, using fallback`, e.message);
                    return null;
                }
            },
            async loadAll() {
                const [monstersData, weaponsData, configData] = await Promise.all([
                    this.loadJSON('data/monsters.json'),
                    this.loadJSON('data/weapons.json'),
                    this.loadJSON('data/config.json')
                ]);

                // JSON ë¡œë“œ ì„±ê³µ ì—¬ë¶€ í™•ì¸
                const jsonLoaded = monstersData && weaponsData;

                if (jsonLoaded) {
                    // JSONì—ì„œ ë¡œë“œ
                    DEFAULT_CONFIG = {
                        weapons: weaponsData.weapons.map((w, i) => ({
                            id: i, name: w.name, val: w.atk, price: w.price || 0, icon: w.icon
                        })),
                        monsters: monstersData.monsters,
                        backgrounds: [
                            { id: 0, name: "ë²½", val: configData?.backgrounds?.wall || "assets/textures/wall.png" },
                            { id: 1, name: "ë°”ë‹¥", val: configData?.backgrounds?.floor || "assets/textures/floor.png" },
                            { id: 2, name: "ì²œì¥", val: configData?.backgrounds?.ceiling || "#050505" }
                        ]
                    };
                    GAME_CONFIG = configData;
                    console.log('ğŸ“¦ JSON Data loaded:', { monsters: DEFAULT_CONFIG.monsters.length, weapons: DEFAULT_CONFIG.weapons.length });
                } else {
                    // í´ë°± ë°ì´í„° ì‚¬ìš©
                    DEFAULT_CONFIG = JSON.parse(JSON.stringify(FALLBACK_DATA));
                    console.log('ğŸ“¦ Using FALLBACK data (CORS/file:// issue)');
                }

                return DEFAULT_CONFIG;
            }
        };

        const settings = {
            data: null,
            async init() {
                // JSONì—ì„œ ë¡œë“œ
                await DataLoader.loadAll();
                const saved = localStorage.getItem('wm_v22');
                this.data = saved ? JSON.parse(saved) : JSON.parse(JSON.stringify(DEFAULT_CONFIG));
            },
            open() {
                document.getElementById('settings-overlay').style.display = 'flex';
                this.renderInputs();
            },
            close() { document.getElementById('settings-overlay').style.display = 'none'; },
            renderInputs() {
                const render = (arr, cid, key) => {
                    const c = document.getElementById(cid);
                    c.innerHTML = '';
                    arr.forEach((it, i) => {
                        const v = it[key];
                        const isUrl = v.indexOf('http') === 0 || v.indexOf('data:') === 0 || v.indexOf('assets/') === 0;
                        c.innerHTML += `<div class="res-row"><div class="res-label">${it.name}</div><input type="text" class="res-input" id="inp-${cid}-${i}" value="${v}"><div class="res-preview">${isUrl ? `<img src="${v}">` : v}</div></div>`;
                    });
                };
                render(this.data.weapons, 'set-weapons', 'icon');
                render(this.data.monsters, 'set-monsters', 'icon');
                render(this.data.backgrounds, 'set-backgrounds', 'val');
            },
            save() {
                const save = (arr, cid, key) => arr.forEach((it, i) => { it[key] = document.getElementById(`inp-${cid}-${i}`).value; });
                save(this.data.weapons, 'set-weapons', 'icon');
                save(this.data.monsters, 'set-monsters', 'icon');
                save(this.data.backgrounds, 'set-backgrounds', 'val');
                localStorage.setItem('wm_v22', JSON.stringify(this.data));
                alert('ì €ì¥ ì™„ë£Œ!');
                if (game) game.reload();
                this.close();
            },
            reset() {
                if (confirm('ì´ˆê¸°í™”?')) {
                    localStorage.removeItem('wm_v22');
                    this.data = JSON.parse(JSON.stringify(DEFAULT_CONFIG));
                    this.renderInputs();
                    if (game) game.reload();
                    alert('ì´ˆê¸°í™” ì™„ë£Œ');
                }
            }
        };

        class Game {
            constructor() {
                this.baseStats = { atk: 10, maxHp: 100, aspd: 1.0, critRate: 5, critDmg: 150 };
                this.invested = { atk: 0, maxHp: 0, aspd: 0, critRate: 0, critDmg: 0 };
                this.statPerPoint = { atk: 2, maxHp: 10, aspd: 0.02, critRate: 0.5, critDmg: 5 };
                this.p = {
                    hp: 100, maxHp: 100, atk: 10, aspd: 1.0, critRate: 5, critDmg: 150,
                    atkRaw: 10, maxHpRaw: 100, aspdRaw: 1.0, critRateRaw: 5, critDmgRaw: 150,
                    gold: 0, diamond: 1000, lv: 1, exp: 0, maxExp: 100, wIdx: 0, statPoints: 5, pityCount: 0,
                    invested: { atk: 0, maxHp: 0, aspd: 0, critRate: 0, critDmg: 0 }
                };
                this.stage = 1;
                this.state = 'IDLE';
                this.e = null;

                // ì›”ë“œ & ë³´ìŠ¤ ì‹œìŠ¤í…œ
                this.stagesPerWorld = 100;
                this.bossInterval = 25;
                this.worldThemes = [
                    { name: "ë˜ì „", hue: 0 },      // ê¸°ë³¸
                    { name: "ìˆ²", hue: 90 },       // ì´ˆë¡
                    { name: "ìš©ì•”ë™êµ´", hue: 20 }, // ì£¼í™©
                    { name: "ì–¼ìŒì„±", hue: 200 },  // íŒŒë‘
                    { name: "ë§ˆì™•ì„±", hue: 280 }   // ë³´ë¼
                ];

                this.reload();
                this.updateUI();
            }

            // í˜„ì¬ ì›”ë“œ ë²ˆí˜¸ (1ë¶€í„° ì‹œì‘)
            get currentWorld() {
                return Math.floor((this.stage - 1) / this.stagesPerWorld) + 1;
            }

            // í˜„ì¬ ì›”ë“œ ë‚´ ìŠ¤í…Œì´ì§€ (1-100)
            get stageInWorld() {
                return ((this.stage - 1) % this.stagesPerWorld) + 1;
            }

            // ë³´ìŠ¤ ìŠ¤í…Œì´ì§€ ì—¬ë¶€
            get isBossStage() {
                return this.stageInWorld % this.bossInterval === 0;
            }

            // í˜„ì¬ ì›”ë“œ í…Œë§ˆ
            get currentTheme() {
                const idx = (this.currentWorld - 1) % this.worldThemes.length;
                return this.worldThemes[idx];
            }

            reload() {
                this.r = settings.data;
                const bg = this.r.backgrounds;
                this.applyBg('.wall-left', bg[0].val);
                this.applyBg('.wall-right', bg[0].val);
                this.applyBg('.floor', bg[1].val);
                this.applyBg('.ceiling', bg[2].val);
                this.updateHand();
            }

            applyBg(sel, v) {
                document.querySelectorAll(sel).forEach(el => {
                    const isImage = v.indexOf('http') === 0 || v.indexOf('data:') === 0 || v.indexOf('assets/') === 0;
                    if (isImage) {
                        el.style.backgroundImage = `url('${v}')`;
                        el.style.backgroundColor = '';
                    } else {
                        el.style.backgroundImage = '';
                        el.style.backgroundColor = v;
                    }
                });
            }

            start() {
                document.getElementById('start-screen').style.display = 'none';
                this.log("ëª¨í—˜ ì‹œì‘!");
                this.walk();
            }

            walk() {
                if (this.p.hp <= 0) { this.die(); return; }
                this.state = 'WALK';
                document.querySelector('.tunnel-container').classList.add('moving');
                document.getElementById('enemy-container').style.display = 'none';
                setTimeout(() => { if (this.state === 'WALK') this.meet(); }, 1500);
            }

            meet() {
                this.state = 'BATTLE';
                document.querySelector('.tunnel-container').classList.remove('moving');

                // ì›”ë“œ í…Œë§ˆ ì ìš© (hue-rotate)
                const theme = this.currentTheme;
                document.querySelector('.tunnel-container').style.filter = `hue-rotate(${theme.hue}deg)`;

                // ë³´ìŠ¤ ìŠ¤í…Œì´ì§€ í™•ì¸
                const isBoss = this.isBossStage;
                const bossMult = isBoss ? 3 : 1; // ë³´ìŠ¤ëŠ” 3ë°° ê°•í•¨

                // ëª¬ìŠ¤í„° ì„ íƒ (ë³´ìŠ¤ë©´ ë§ˆì§€ë§‰ ëª¬ìŠ¤í„°, ì•„ë‹ˆë©´ ëœë¤)
                const ml = this.r.monsters;
                const b = isBoss ? ml[ml.length - 1] : ml[Math.floor(Math.random() * (ml.length - 1))];

                // ìŠ¤ì¼€ì¼ë§: ìŠ¤í…Œì´ì§€ + ì›”ë“œ ë³´ë„ˆìŠ¤
                const stageScale = 1 + this.stage * 0.1;
                const worldScale = 1 + (this.currentWorld - 1) * 0.5;
                const m = stageScale * worldScale * bossMult;

                this.e = {
                    name: isBoss ? `ğŸ‘‘ ${b.name} (ë³´ìŠ¤)` : b.name,
                    isBoss: isBoss,
                    maxHp: Math.floor(b.hp * m),
                    hp: Math.floor(b.hp * m),
                    atk: Math.floor(b.atk * m),
                    def: Math.floor((b.def || 0) * m * 0.5),
                    aspd: b.aspd || 1.0,
                    exp: Math.floor((b.exp || 10) * m * (isBoss ? 5 : 1)),
                    gold: Math.floor((b.gold || 15) * m * (isBoss ? 5 : 1)),
                    icon: b.icon
                };

                const em = document.getElementById('enemy-emoji');
                const im = document.getElementById('enemy-img');
                const isImage = this.e.icon.indexOf('http') === 0 || this.e.icon.indexOf('data:') === 0 || this.e.icon.indexOf('assets/') === 0;
                if (isImage) {
                    em.style.display = 'none'; im.style.display = 'block'; im.src = this.e.icon;
                    // ë³´ìŠ¤ë©´ í¬ê²Œ í‘œì‹œ
                    im.style.transform = isBoss ? 'scale(1.3)' : 'scale(1)';
                    im.style.filter = isBoss ? 'drop-shadow(0 0 30px gold)' : 'drop-shadow(0 0 20px rgba(255,0,0,0.5))';
                } else {
                    im.style.display = 'none'; em.style.display = 'block'; em.innerText = this.e.icon;
                }
                document.getElementById('enemy-container').style.display = 'block';
                document.getElementById('hud-name').innerText = this.e.name;
                document.getElementById('hud-stage').innerText = `W${this.currentWorld}-${this.stageInWorld}`;
                this.updateEHp();

                if (isBoss) {
                    this.log(`ğŸ”¥ ë³´ìŠ¤ ë“±ì¥! ${this.e.name}`);
                } else {
                    this.log(`â— ${this.e.name} ë“±ì¥!`);
                }

                const attackDelay = 1000 / this.p.aspd;
                setTimeout(() => this.round(), attackDelay);
            }

            async round() {
                if (this.state !== 'BATTLE') return;
                this.atk(true);
                if (this.e.hp <= 0) { setTimeout(() => this.win(), 500); return; }
                const attackDelay = 1000 / this.p.aspd;
                await this.wait(attackDelay * 0.6);
                if (this.state === 'BATTLE') {
                    this.atk(false);
                    if (this.p.hp <= 0) this.die();
                    else setTimeout(() => this.round(), attackDelay * 0.4);
                }
            }

            atk(isP) {
                if (isP) {
                    const h = document.getElementById('right-hand');
                    h.classList.add('attack-anim');
                    setTimeout(() => h.classList.remove('attack-anim'), 200);
                    const w = this.r.weapons[this.p.wIdx];
                    let d = this.p.atk + this.getWeaponAtk(w);
                    d = Math.max(1, d - Math.floor(this.e.def * 0.5));
                    let isCrit = Math.random() * 100 < this.p.critRate;
                    if (isCrit) d = Math.floor(d * (this.p.critDmg / 100));
                    this.e.hp = Math.max(0, this.e.hp - d);
                    this.updateEHp();
                    this.showDmg(d, isCrit, false);
                    this.log(`âš”ï¸ ê³µê²©! ${NumFormat.format(d)} í”¼í•´${isCrit ? ' (ì¹˜ëª…íƒ€!)' : ''}`);
                } else {
                    const g = document.getElementById('game-container');
                    g.classList.add('shake');
                    setTimeout(() => g.classList.remove('shake'), 300);
                    let d = this.e.atk;
                    this.p.hp = Math.max(0, this.p.hp - d);
                    this.updateUI();
                    this.showDmg(d, false, true);
                    this.log(`ğŸ›¡ï¸ í”¼ê²©! -${NumFormat.format(d)} HP`);
                }
            }

            win() {
                // ë³´ìŠ¤ ì²˜ì¹˜ ì‹œ ë‹¤ì´ì•„ ë³´ìƒ
                if (this.e.isBoss) {
                    const diamondReward = 5 + this.currentWorld * 5; // ì›”ë“œë‹¹ +5
                    this.p.diamond += diamondReward;
                    this.log(`ğŸ† ë³´ìŠ¤ ì²˜ì¹˜! +${NumFormat.format(this.e.exp)}EXP +${NumFormat.format(this.e.gold)}G +${diamondReward}ğŸ’`);
                } else {
                    this.log(`ğŸ† ìŠ¹ë¦¬! +${NumFormat.format(this.e.exp)}EXP +${NumFormat.format(this.e.gold)}G`);
                }

                this.p.gold += this.e.gold;
                this.p.exp += this.e.exp;
                if (this.p.exp >= this.p.maxExp) {
                    this.p.lv++;
                    this.p.exp = 0;
                    this.p.maxExp = Math.floor(this.p.maxExp * 1.2);
                    this.p.statPoints += 5;
                    this.p.hp = this.p.maxHp;
                    this.log(`ğŸ‰ ë ˆë²¨ì—…! (Lv.${this.p.lv}) +5 ìŠ¤íƒ¯ í¬ì¸íŠ¸!`);
                }
                this.stage++;
                this.updateUI();
                this.walk();
            }

            die() {
                this.log(`ğŸ’€ ì‚¬ë§... ë³µê·€`);
                this.stage = 1; this.p.hp = this.p.maxHp;
                document.getElementById('enemy-container').style.display = 'none';
                this.updateUI();
                setTimeout(() => this.walk(), 3000);
            }

            // ëª¨ë“  ì˜¤ë²„ë ˆì´ ë‹«ê¸°
            closeAllOverlays() {
                document.getElementById('shop-overlay').style.display = 'none';
                document.getElementById('gacha-overlay').style.display = 'none';
                document.getElementById('stat-overlay').style.display = 'none';
                document.getElementById('settings-overlay').style.display = 'none';
            }

            openShop() {
                this.closeAllOverlays();
                document.getElementById('shop-overlay').style.display = 'flex';
                document.getElementById('shop-gold').innerText = NumFormat.format(this.p.gold);

                // í˜„ì¬ ì¥ë¹„ í‘œì‹œ
                this.updateShopEquipment();

                // ë¬´ê¸° ëª©ë¡ ë Œë”ë§
                this.renderWeaponShop();

                // ê¸°ë³¸ íƒ­ìœ¼ë¡œ ë¦¬ì…‹
                this.switchShopTab('items');
            }

            closeShop() {
                document.getElementById('shop-overlay').style.display = 'none';
            }

            updateShopEquipment() {
                const w = this.r.weapons[this.p.wIdx];
                const iconEl = document.getElementById('shop-weapon-icon');
                const isImage = w.icon && (w.icon.indexOf('http') === 0 || w.icon.indexOf('data:') === 0 || w.icon.indexOf('assets/') === 0);
                if (isImage) {
                    iconEl.innerHTML = `<img src="${w.icon}" style="width:40px;height:40px;">`;
                } else {
                    iconEl.innerText = w.icon || 'ğŸ‘Š';
                }
                const gradeInfo = this.getGradeInfo(w.grade);
                const nameEl = document.getElementById('shop-weapon-name');
                nameEl.innerText = `[${gradeInfo.name}] ${w.name}`;
                nameEl.style.color = gradeInfo.color;
                document.getElementById('shop-weapon-atk').innerText = `ê³µê²©ë ¥ +${this.getWeaponAtk(w)}`;
            }

            renderWeaponShop() {
                const container = document.getElementById('shop-weapons-tab');
                container.innerHTML = '';
                this.r.weapons.forEach((w, i) => {
                    if (i === 0) return; // ë§¨ì£¼ë¨¹ ì œì™¸
                    const owned = this.p.wIdx === i;
                    const canBuy = this.p.gold >= w.price && !owned && w.price > 0;
                    const isImage = w.icon && (w.icon.indexOf('http') === 0 || w.icon.indexOf('data:') === 0 || w.icon.indexOf('assets/') === 0);
                    const iconHtml = isImage ? `<img src="${w.icon}" style="width:24px;height:24px;vertical-align:middle;">` : (w.icon || 'ğŸ—¡ï¸');
                    const gradeInfo = this.getGradeInfo(w.grade);
                    const weaponAtk = this.getWeaponAtk(w);
                    const priceText = w.price === 0 ? 'ë½‘ê¸° ì „ìš©' : w.price + 'G';
                    container.innerHTML += `
                        <div class="shop-item ${owned ? 'owned' : ''}" style="border-left:3px solid ${gradeInfo.color};${owned ? 'border:2px solid #27ae60;' : ''}" onclick="${canBuy ? `game.buyWeapon(${i})` : ''}">
                            <span style="color:${gradeInfo.color}">${iconHtml} [${gradeInfo.name}] ${w.name} (+${weaponAtk})</span>
                            <span style="color:${owned ? '#27ae60' : (w.price === 0 ? '#ff9800' : '#f1c40f')}">${owned ? 'ì¥ì°©ì¤‘' : priceText}</span>
                        </div>
                    `;
                });
            }

            switchShopTab(tab) {
                document.getElementById('shop-items-tab').style.display = tab === 'items' ? 'block' : 'none';
                document.getElementById('shop-weapons-tab').style.display = tab === 'weapons' ? 'block' : 'none';
                document.querySelectorAll('.shop-tab').forEach((btn, i) => {
                    btn.classList.toggle('active', (i === 0 && tab === 'items') || (i === 1 && tab === 'weapons'));
                });
            }

            buyWeapon(idx) {
                const w = this.r.weapons[idx];
                if (this.p.gold >= w.price) {
                    this.p.gold -= w.price;
                    this.p.wIdx = idx;
                    this.log(`ğŸ—¡ï¸ ${w.name} êµ¬ë§¤!`);
                    this.updateUI();
                    this.updateHand();
                    this.updateShopEquipment();
                    this.renderWeaponShop();
                    document.getElementById('shop-gold').innerText = NumFormat.format(this.p.gold);
                }
            }

            // ë½‘ê¸° ê´€ë ¨ í•¨ìˆ˜
            openGacha() {
                this.closeAllOverlays();
                document.getElementById('gacha-overlay').style.display = 'flex';
                document.getElementById('gacha-diamond').innerText = NumFormat.format(this.p.diamond);
                document.getElementById('gacha-pity').innerText = this.p.pityCount;
                document.getElementById('gacha-result').style.display = 'none';
            }

            closeGacha() {
                document.getElementById('gacha-overlay').style.display = 'none';
            }

            doGacha(count) {
                const cost = count === 10 ? 900 : 100;
                if (this.p.diamond < cost) {
                    this.log('ğŸ’ ë‹¤ì´ì•„ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤!');
                    return;
                }

                this.p.diamond -= cost;
                const results = [];

                for (let i = 0; i < count; i++) {
                    this.p.pityCount++;
                    const grade = this.rollGrade();
                    const weaponsOfGrade = this.r.weapons.filter(w => w.grade === grade);
                    const weapon = weaponsOfGrade.length > 0
                        ? weaponsOfGrade[Math.floor(Math.random() * weaponsOfGrade.length)]
                        : this.r.weapons[1];
                    results.push({ weapon, grade });

                    // 10ì—°ì°¨ ë³´ë„ˆìŠ¤: ë ˆì–´ ì´ìƒ í™•ì •
                    if (count === 10 && i === 9 && !results.some(r => ['rare', 'epic', 'legendary'].includes(r.grade))) {
                        const rareWeapons = this.r.weapons.filter(w => ['rare', 'epic', 'legendary'].includes(w.grade));
                        if (rareWeapons.length > 0) {
                            results[9] = { weapon: rareWeapons[Math.floor(Math.random() * rareWeapons.length)], grade: 'rare' };
                        }
                    }
                }

                // ê°€ì¥ ì¢‹ì€ ë¬´ê¸° ì¥ì°©
                const best = results.reduce((a, b) => {
                    const gradeOrder = ['common', 'uncommon', 'rare', 'epic', 'legendary'];
                    return gradeOrder.indexOf(a.grade) > gradeOrder.indexOf(b.grade) ? a : b;
                });

                const bestIdx = this.r.weapons.findIndex(w => w.id === best.weapon.id || w.name === best.weapon.name);
                if (bestIdx > this.p.wIdx) {
                    this.p.wIdx = bestIdx;
                }

                // ê²°ê³¼ í‘œì‹œ
                this.showGachaResult(results);
                this.updateUI();
                document.getElementById('gacha-diamond').innerText = NumFormat.format(this.p.diamond);
                document.getElementById('gacha-pity').innerText = this.p.pityCount;
            }

            rollGrade() {
                const gacha = this.r.gacha || FALLBACK_DATA.gacha;
                const pity = this.p.pityCount;

                // ì²œì¥ ì²´í¬
                if (pity >= gacha.pity.legendary) {
                    this.p.pityCount = 0;
                    return 'legendary';
                }
                if (pity >= gacha.pity.epic && pity % gacha.pity.epic === 0) {
                    return 'epic';
                }

                // í™•ë¥  ë½‘ê¸°
                const rates = gacha.rates;
                const roll = Math.random() * 100;
                let sum = 0;
                for (const [grade, rate] of Object.entries(rates)) {
                    sum += rate;
                    if (roll < sum) return grade;
                }
                return 'common';
            }
            showGachaResult(results) {
                const container = document.getElementById('gacha-result');
                container.style.display = 'flex';
                container.style.flexWrap = 'wrap';
                container.style.justifyContent = 'center';
                container.style.gap = '10px';

                // ê²°ê³¼ HTML ìƒì„±
                container.innerHTML = results.map(r => {
                    const gradeInfo = this.getGradeInfo(r.grade);
                    const isImage = r.weapon.icon.indexOf('assets/') === 0;
                    const iconHtml = isImage ? `<img src="${r.weapon.icon}" style="width:40px;height:40px;">` : `<span style="font-size:30px">${r.weapon.icon}</span>`;

                    return `<div style="width:100px; padding:10px; background:rgba(0,0,0,0.3); border-radius:10px; border:2px solid ${gradeInfo.color}; display:flex; flex-direction:column; align-items:center;">
                                ${iconHtml}
                                <span style="color:${gradeInfo.color}; font-size:11px; margin-top:5px; font-weight:bold;">${gradeInfo.name}</span>
                                <span style="font-size:12px; margin-top:2px; text-align:center; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; width:100%;">${r.weapon.name}</span>
                            </div>`;
                }).join('');

                const best = results.reduce((a, b) => {
                    const order = ['common', 'uncommon', 'rare', 'epic', 'legendary'];
                    return order.indexOf(a.grade) > order.indexOf(b.grade) ? a : b;
                });
                this.log(`ğŸ° ${results.length}íšŒ ë½‘ê¸°! ìµœê³ : [${this.getGradeInfo(best.grade).name}] ${best.weapon.name}`);
            }

            buy(t) {
                if (t === 'potion' && this.p.gold >= 50) { this.p.gold -= 50; this.p.hp = this.p.maxHp; this.log("ğŸ’– ì²´ë ¥ íšŒë³µ!"); }
                else if (t === 'upgrade' && this.p.gold >= 100) { this.p.gold -= 100; this.p.atk += 5; this.log("ğŸ’ª ê³µê²©ë ¥ +5!"); }
                else if (t === 'aspd' && this.p.gold >= 150) { this.p.gold -= 150; this.p.aspd += 0.1; this.log("âš¡ ê³µê²©ì†ë„ +0.1!"); }
                else if (t === 'critRate' && this.p.gold >= 200) { this.p.gold -= 200; this.p.critRate = Math.min(this.p.critRate + 1, 100); this.log("ğŸ¯ ì¹˜ëª…íƒ€í™•ë¥  +1%!"); }
                else if (t === 'critDmg' && this.p.gold >= 250) { this.p.gold -= 250; this.p.critDmg += 10; this.log("ğŸ’¥ ì¹˜ëª…íƒ€ë°°ìˆ˜ +10%!"); }
                else if (t === 'gacha' && this.p.gold >= 200) {
                    this.p.gold -= 200;
                    const wl = this.r.weapons;
                    const i = Math.floor(Math.random() * (wl.length - 1)) + 1;
                    this.p.wIdx = i;
                    this.log(`ğŸ² ${wl[i].name} íšë“!`);
                }
                this.updateUI();
                this.updateHand();
                document.getElementById('shop-gold').innerText = NumFormat.format(this.p.gold);
            }

            updateHand() {
                const w = this.r.weapons[this.p.wIdx];
                const em = document.getElementById('hand-emoji');
                const im = document.getElementById('hand-img');
                const isImage = w.icon.indexOf('http') === 0 || w.icon.indexOf('data:') === 0 || w.icon.indexOf('assets/') === 0;
                if (isImage) {
                    em.style.display = 'none'; im.style.display = 'block'; im.src = w.icon;
                } else {
                    im.style.display = 'none'; em.style.display = 'block'; em.innerText = w.icon;
                }
                document.getElementById('ui-weapon').innerText = w.name;
            }

            updateUI() {
                document.getElementById('ui-lv').innerText = this.p.lv;
                document.getElementById('ui-hp').innerText = NumFormat.format(this.p.hp);
                document.getElementById('ui-maxhp').innerText = NumFormat.format(this.p.maxHp);
                document.getElementById('ui-gold').innerText = NumFormat.format(this.p.gold);
                document.getElementById('ui-diamond').innerText = NumFormat.format(this.p.diamond);

                // EXP ë°” ì—…ë°ì´íŠ¸
                document.getElementById('ui-exp').innerText = this.p.exp;
                document.getElementById('ui-maxexp').innerText = this.p.maxExp;
                const expPercent = (this.p.exp / this.p.maxExp) * 100;
                document.getElementById('exp-bar-fill').style.width = Math.min(100, expPercent) + '%';

                const w = this.r.weapons[this.p.wIdx];
                const weaponAtk = this.getWeaponAtk(w);
                const totalAtk = this.p.atk + weaponAtk;
                document.getElementById('stat-atk').innerText = NumFormat.format(totalAtk);
                document.getElementById('stat-maxhp').innerText = NumFormat.format(this.p.maxHp);
                document.getElementById('stat-aspd').innerText = this.p.aspd.toFixed(2);
                document.getElementById('stat-crit').innerText = NumFormat.percent(this.p.critRate, 1);
                document.getElementById('stat-critdmg').innerText = NumFormat.percent(this.p.critDmg, 0);

                // ë¬´ê¸° ì´ë¦„ì— ë“±ê¸‰ ìƒ‰ìƒ ì ìš©
                const gradeInfo = this.getGradeInfo(w.grade);
                const weaponEl = document.getElementById('ui-weapon');
                weaponEl.innerText = w.name;
                weaponEl.style.color = gradeInfo.color;

                this.updateHand();
            }

            // ë¬´ê¸° ê³µê²©ë ¥ ê³„ì‚° (ê¸°ë³¸ + ë“±ê¸‰ ë°°ìˆ˜)
            getWeaponAtk(w) {
                const baseAtk = w.baseAtk || w.val || 0;
                const gradeInfo = this.getGradeInfo(w.grade);
                return Math.floor(baseAtk * gradeInfo.multiplier);
            }

            // ë“±ê¸‰ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            getGradeInfo(grade) {
                const grades = this.r.grades || FALLBACK_DATA.grades;
                return grades[grade] || grades.common;
            }

            updateEHp() {
                if (!this.e) return;
                const p = (this.e.hp / this.e.maxHp) * 100;
                document.getElementById('hp-fill-enemy').style.width = Math.max(0, p) + "%";
            }

            showDmg(v, c, isP) {
                const w = document.getElementById('game-container');
                const el = document.createElement('div');
                el.className = 'dmg-text';
                el.innerText = NumFormat.format(v) + (c ? "!" : "");
                if (isP) { el.style.color = 'red'; el.style.top = '60%'; }
                else if (c) { el.style.color = 'orange'; el.style.fontSize = "70px"; }
                w.appendChild(el);
                setTimeout(() => el.remove(), 800);
            }

            log(m) {
                const b = document.getElementById('log-box');
                b.innerHTML += `<div>${m}</div>`;
                b.scrollTop = b.scrollHeight;
            }

            // ìŠ¤íƒ¯ íŒ¨ë„
            openStatPanel() {
                this.closeAllOverlays();
                document.getElementById('stat-overlay').style.display = 'flex';
                this.updateStatPanel();
            }

            closeStatPanel() {
                document.getElementById('stat-overlay').style.display = 'none';
            }

            updateStatPanel() {
                document.getElementById('avail-points').innerText = this.p.statPoints;
                document.getElementById('sp-atk').innerText = NumFormat.format(this.p.atk);
                document.getElementById('sp-atk-inv').innerText = `(+${this.p.invested.atk})`;
                document.getElementById('sp-maxHp').innerText = NumFormat.format(this.p.maxHp);
                document.getElementById('sp-maxHp-inv').innerText = `(+${this.p.invested.maxHp})`;
                document.getElementById('sp-aspd').innerText = this.p.aspd.toFixed(2);
                document.getElementById('sp-aspd-inv').innerText = `(+${this.p.invested.aspd})`;
                document.getElementById('sp-critRate').innerText = NumFormat.percent(this.p.critRate, 1);
                document.getElementById('sp-critRate-inv').innerText = `(+${this.p.invested.critRate})`;
                document.getElementById('sp-critDmg').innerText = NumFormat.percent(this.p.critDmg, 0);
                document.getElementById('sp-critDmg-inv').innerText = `(+${this.p.invested.critDmg})`;
                document.querySelectorAll('.stat-btn-add').forEach(btn => { btn.disabled = this.p.statPoints <= 0; });
            }

            investStat(statName) {
                if (this.p.statPoints <= 0) return;
                this.p.statPoints--;
                this.p.invested[statName]++;
                const increase = this.statPerPoint[statName];
                this.p[statName] += increase;
                if (statName === 'maxHp') this.p.hp += increase;
                if (statName === 'critRate' && this.p.critRate > 100) this.p.critRate = 100;
                this.updateStatPanel();
                this.updateUI();
            }

            resetStats() {
                if (!confirm('ì •ë§ ìŠ¤íƒ¯ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
                const totalInvested = Object.values(this.p.invested).reduce((a, b) => a + b, 0);
                this.p.statPoints += totalInvested;
                this.p.atk = this.baseStats.atk;
                this.p.maxHp = this.baseStats.maxHp;
                this.p.aspd = this.baseStats.aspd;
                this.p.critRate = this.baseStats.critRate;
                this.p.critDmg = this.baseStats.critDmg;
                this.p.hp = this.p.maxHp;
                this.p.invested = { atk: 0, maxHp: 0, aspd: 0, critRate: 0, critDmg: 0 };
                this.updateStatPanel();
                this.updateUI();
                this.log('ğŸ”„ ìŠ¤íƒ¯ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤!');
            }

            recalcStats() {
                this.p.atk = this.p.atkRaw;
                this.p.maxHp = this.p.maxHpRaw;
                this.p.aspd = this.p.aspdRaw;
                this.p.critRate = this.p.critRateRaw;
                this.p.critDmg = this.p.critDmgRaw;
            }

            wait(ms) { return new Promise(r => setTimeout(r, ms)); }
        }

        // ê²Œì„ ì´ˆê¸°í™” (async)
        let game = null;
        (async () => {
            await settings.init();
            game = new Game();
            console.log('ğŸ® Game initialized with JSON data');
        })();
    </script>
</body>

</html>